"use strict";angular.module("jlogApp.services",[]),angular.module("jlogApp.filters",[]),angular.module("jlogApp.controllers",[]),angular.module("jlogApp.directives",[]),angular.module("jlogApp",["ui.router","jlogApp.controllers","jlogApp.filters","jlogApp.services","jlogApp.directives"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/battle"),a.state("battle",{url:"/battle",views:{"page@":{templateUrl:"partials/battle_list.html",controller:"listCtrl"},"bottom-bar@":{templateUrl:"partials/battle_list_menu.html",controller:"listBottomCtrl"}},data:{}}).state("battle.view",{url:"/view/:index",views:{"page@":{templateUrl:"partials/battle_view.html",controller:"listViewCtrl"},"bottom-bar@":{templateUrl:"partials/battle_view_menu.html",controller:"listViewBottomCtrl"}},data:{}}).state("battle.edit",{url:"/edit/:index",views:{"page@":{templateUrl:"partials/battle_edit.html",controller:"listEditCtrl"},"bottom-bar@":{templateUrl:"partials/battle_edit_menu.html",controller:"listEditBottomCtrl"}},data:{}}).state("filter",{url:"/filter",views:{"page@":{templateUrl:"partials/filter.html",controller:"filterEditCtrl"},"bottom-bar@":{templateUrl:"partials/filter_menu.html",controller:"filterEditBottomCtrl"}},data:{}}).state("stats",{url:"/stats",views:{"page@":{templateUrl:"partials/stats.html",controller:"statsCtrl"},"bottom-bar@":{templateUrl:"partials/stats_menu.html",controller:"statsBottomCtrl"}},data:{}}).state("backup",{url:"/backup",views:{"page@":{templateUrl:"partials/backup.html",controller:"backupCtrl"}}}).state("info",{url:"/info",views:{"page@":{templateUrl:"partials/info.html"}}})}]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]),angular.module("jlogApp.controllers").controller("backupCtrl",["$scope","fileImport","igParser","fileExport","server",function(a,b,c,d,e){function f(){var b=(new Date).getTime();a.backup={url:d.generate("json",a.battles.list),name:"jlog_"+b+".json"}}c.init(),f(),a.read_result={},a.doReadFile=function(c,d){a.read_result[c]=[],b.read(c,d).then(function(b){var d=b[0],e=b[1];e.push("imported "+d.length+" battles"),a.setBattles(d),a.read_result[c]=e,a.stateGo("battle")},function(b){a.read_result[c]=b})},a.upload={id:null,msg:null},a.doUploadData=function(){a.upload={id:null,msg:"Uploading..."},e.upload(a.battles.list).then(function(b){a.upload={id:b[0],msg:b[1]}})},a.download={id:null,msg:null},a.doDownloadData=function(){_.isString(a.download.id)&&!s.isBlank(a.download.id)&&e.download(a.download.id).then(function(b){a.download.msg=b[1],_.exists(b[0])&&(a.setBattles(b[0]),a.stateGo("battle"))})}}]),angular.module("jlogApp.controllers").controller("filterEditCtrl",["$scope",function(){}]).controller("filterEditBottomCtrl",["$scope","$window","filter",function(a,b,c){a.doBack=function(){a.battles.filter.cache=c.clearCache(a.battles.filter.cache),a.battles.filter.active=!0,a.updateBattles(),b.history.back()}}]),angular.module("jlogApp.controllers").controller("listCtrl",["$scope",function(a){a.doViewBattle=function(b){a.stateGo("battle.view",{index:b})}}]).controller("listBottomCtrl",["$scope","battles","fileExport",function(a,b,c){a.doAddBattle=function(){a.stateGo("battle.edit",{index:a.battles.list.length})},a.doSortBy=function(c){a.battles.sort=b.updateSortBy(a.sort_types,a.battles.sort,c),a.updateBattles()},a.exports={},a.doExportOpen=function(){var d=(new Date).getTime();a.exports={json:{name:"battles_"+d+".json",url:c.generate("json",a.battles.display_list),label:"JSON"},csv:{name:"battles_"+d+".csv",url:c.generate("csv",b.toTable(a.battles.display_list)),label:"CSV"},bb:{name:"battles_"+d+".txt",url:c.generate("bb",b.toTable(a.battles.display_list)),label:"BB Code"}}}}]),angular.module("jlogApp.controllers").controller("listEditCtrl",["$scope","$state","$stateParams","$window","battle","events","opponents","scenarios","tags",function(a,b,c,d,e,f,g,h,i){var j=parseFloat(c.index);a.battle=j<a.battles.list.length?_.snapshot(a.battles.list[j]):e.create({index:j}),b.current.data.index=j,b.current.data.battle=a.battle,b.current.data.save_enable=!1,a.$watch("battle_edit.$valid",function(a){b.current.data.save_enable=a});var k={opponent:g,event:f,scenario:h},l={opponent:["opponent","name"],event:["setup","event"],scenario:["setup","scenario"]};a.doAdd=function(c){var e=d.prompt("Enter new "+c+" name :");_.exists(e)&&(e=s(e).clean().toLowerCase().value(),s.isBlank(e)||(a.battles[c+"s"]=k[c].add(a.battles[c+"s"],e),a.battle=_.setPath(a.battle,e,l[c],{}),b.current.data.battle=a.battle))},a.doDelete=function(c){var e=_.getPath(a.battle,l[c]);if(_.exists(e)){var f=d.confirm("All references to "+e+" will be deleted.");f&&(a.battles[c+"s"]=k[c].drop(a.battles[c+"s"],e),a.battle=_.setPath(a.battle,null,l[c],{}),b.current.data.battle=a.battle)}},a.doAddTag=function(){var c=d.prompt("Enter new tag name :");_.exists(c)&&(c=s(c).clean().toLowerCase().value(),s.isBlank(c)||(a.battles.tags=i.add(a.battles.tags,c),a.battle=e.addTag(a.battle,c),b.current.data.battle=a.battle))},a.doDeleteTag=function(){var b=a.battle.tags;if(!_.isEmpty(b)){var c=d.confirm("All references to "+b.join(",")+" will be deleted.");c&&(a.battles.tags=i.drop(a.battles.tags,b),a.battle.tags=[])}}}]).controller("listEditBottomCtrl",["$scope","$state","battles","filter",function(a,b,c,d){a.state=b.current.data,a.doSave=function(){a.battles.filter.cache=d.clearCache(a.battles.filter.cache,b.current.data.index),a.setBattles(c.save(a.battles.list,b.current.data.index,b.current.data.battle)),a.doClose()},a.doClose=function(){a.stateGo("battle")}}]),angular.module("jlogApp.controllers").controller("listViewCtrl",["$scope","$stateParams",function(a,b){a.battle=a.battles.list[b.index]}]).controller("listViewBottomCtrl",["$scope","$stateParams","$window","battles",function(a,b,c,d){a.doEditBattle=function(){a.stateGo("battle.edit",{index:b.index})},a.doDeleteBattle=function(){var e=c.confirm("You sure you wanna delete this battle ?");e&&(a.setBattles(d.drop(a.battles.list,parseFloat(b.index))),a.doClose())},a.doClose=function(){a.stateGo("battle")}}]),angular.module("jlogApp.controllers").controller("mainCtrl",["$scope","$state","$q","scores","factions","scenarios","battles","events","opponents","tags","filter",function(a,b,c,d,e,f,g,h,i,j,k){a.stateIs=_.bind(b.is,b),a.stateGo=_.bind(b.go,b),a.battles={list:[],display_list:[],events:[],opponents:[],scenarios:[],tags:[],sort:{type:"date",reverse:!0},filter:{state:k.create(),invert:!1,cache:{}}},a.updateBattles=function(){var b=a.battles.filter.active?_.filter(a.battles.list,_.partial(k.match,a.battles.filter.state,_,a.battles.filter.invert,a.battles.filter.cache)):a.battles.list;a.battles.display_list=g.sort(b,a.sort_types,a.battles.sort.type,a.battles.sort.reverse),a.battles.size=a.battles.display_list.length},a.setBattles=function(b){a.battles.list=g.buildIndex(b),a.battles.opponents=i.fromBattles(a.battles.list),a.battles.events=h.fromBattles(a.battles.list),a.battles.tags=j.fromBattles(a.battles.list),a.battles.scenarios=f.fromBattles(a.battles.list),a.updateBattles()},c.when(d.data()).then(function(b){return a.scores=b,c.when(e.data())}).then(function(b){return a.factions=b,c.when(f.data())}).then(function(){return c.when(g.sortTypes())}).then(function(b){a.sort_types=b}).then(function(){a.setBattles([])}),a.doToggleFilterActive=function(){a.battles.filter.active=!a.battles.filter.active,a.updateBattles()},a.doToggleFilterInvert=function(){a.battles.filter.invert=!a.battles.filter.invert,a.updateBattles()}}]),angular.module("jlogApp.controllers").controller("statsCtrl",["$scope","$state","stats",function(a,b,c){c.init(),a.stats={},b.current.data={entry:"result",selector:"total",selector_arg:null,doGenerate:function(){a.stats=c.generate(a.stats,a.battles.display_list,this.entry,this.selector,this.selector_arg)}},a.state=b.current.data,a.$watch("battles.display_list",function(b){_.isEmpty(b)||a.state.doGenerate()})}]).controller("statsBottomCtrl",["$scope","$state","stats",function(a,b,c){a.SELECTORS=c.SELECTORS,a.ENTRIES=c.ENTRIES,a.state=b.current.data,a.doSetEntry=function(b){a.state.entry=b,a.state.doGenerate()},a.doSetSelector=function(b){a.state.selector_arg=a.state.selector===b?a.state.selector_arg:null,a.state.selector=b,a.state.doGenerate()}}]),angular.module("jlogApp.directives").factory("appCache",["$window","$rootScope",function(a){function b(a){var b="progress"===a.type;c.progress=b?(c.progress+1)%100:0,c.onProgress(b)}var c={progress:0,onProgress:function(){},onUpdateReady:function(){}},d=a.applicationCache;return d.addEventListener("cached",b,!1),d.addEventListener("checking",b,!1),d.addEventListener("downloading",b,!1),d.addEventListener("error",b,!1),d.addEventListener("noupdate",b,!1),d.addEventListener("obsolete",b,!1),d.addEventListener("progress",b,!1),d.addEventListener("updateready",function(a){d.status===d.UPDATEREADY&&c.onUpdateReady(),c.progress=0,c.onProgress(!1)},!1),c}]).directive("appCacheProgressBar",function(){return{restrict:"E",template:'<div class="appcache-progress"     ng-show="appCache.progress != 0">  <div class="appcache-progress-bar"       ng-style="{\'width\': appCache.progress + \'%\' }"></div></div>',controller:["$scope","$window","appCache",function(a,b,c){a.appCache=c,c.onProgress=function(){a.$apply()},c.onUpdateReady=function(){b.confirm("A new version of this site is available. Load it?")&&b.location.reload()}}],link:function(){}}}),angular.module("jlogApp.directives").controller("barsCtrl",["$scope",function(a){a.$watch("values",function(b){if(_.exists(b)){var c=Math.max.apply(null,_.values(b)),d=30/Math.max(1,_.keys(b).length-1);a.bars=_.chain(b).map(function(b,d){return{k:d,name:s.capitalize(d),width:a.width*b/c,value:b}}).sortBy(function(a){return-a.value}).map(function(b,c){return b.color=_.exists(_.getPath(a.hues,b.k))?"hsl("+_.getPath(a.hues,b.k)[0]+", "+_.getPath(a.hues,b.k)[1]+"%, 52%)":"hsl("+a.hue+", "+a.saturation+"%, "+(35+c*d)+"%)",b}).value()}})}]).directive("bars",[function(){return{restrict:"E",templateUrl:"partials/directives/bars.html",scope:{values:"=barsValues",hues:"=barsHues"},controller:"barsCtrl",link:function(a,b,c){a.width=.7*(b[0].querySelector("table").offsetWidth>>0),a.height=50,a.hue="200",c.$observe("barsHue",function(b){a.hue=_.exists(b)?b:"200"}),a.saturation="75",c.$observe("barsSaturation",function(b){a.saturation=_.exists(b)?b:"75"})}}}]),angular.module("jlogApp.directives").directive("collapse",function(){return{restrict:"A",link:function(a,b,c){a.$watch(c.collapse,function(a){a?b.addClass("collapse"):b.removeClass("collapse")})}}}),angular.module("jlogApp.directives").directive("closeAllDropdown",[function(){return{restrict:"A",link:function(a,b){b.on("click",function(){a.$broadcast("close-dropdown")})}}}]).directive("openDropdown",[function(){return{restrict:"A",link:function(a,b,c){var d=c.openDropdown,e=angular.element(document.getElementById(d));_.exists(e)&&(b.on("click",function(a){e.toggleClass("open"),a.stopPropagation()}),a.$on("close-dropdown",function(){e.removeClass("open")}))}}}]),angular.module("jlogApp.directives").directive("eaFile",function(){return{restrict:"A",scope:{eaFile:"&"},controller:["$scope",function(){}],link:function(a,b){b[0].onchange=function(){a.eaFile({file:b[0].files[0]})}}}}),angular.module("jlogApp.directives").directive("exportLink",function(){return{restrict:"A",transclude:!0,scope:{name:"@",type:"@",source:"="},template:'<a> </a> <a class="clickable" ng-click="exportSource()" ng-transclude> </a>',controller:["$scope","$window",function(a,b){a.file_url=null,a.file_name=a.name+"."+a.type,a.exportSource=function(){var c=a.source["export"](a.type),d=a.file_url;a.file_url=null,null!==d&&b.URL.revokeObjectURL(d);var e=new b.Blob([c],{type:"text/plain"});b.URL=b.URL||b.webkitURL;var f=b.URL.createObjectURL(e);a.file_url=f;var g=new Date;a.file_name=a.name+"_"+g.getTime()+"."+a.type,a.launchDownload()}}],link:function(a,b){var c=b.find("a")[0];a.launchDownload=function(){c.href=a.file_url,c.download=a.file_name,c.click()}}}}),angular.module("jlogApp.directives").controller("pieChartCtrl",["$scope",function(a){a.$watch("values",function(b){if(a.center={x:a.width/2,y:a.height/2},a.radius=Math.min(a.width,a.height)/2*.95,_.exists(b)){a.legends=_.chain(b.legends).map(function(a,c){return{label:a,count:"#"+b.values[c],color:b.colors[c]}}).filter(function(a,c){return b.values[c]>0}).value(),a.total=_.reduce(b.values,function(a,b){return a+b},0);var c=0;a.paths=_.chain(b.values).map(function(d,e){var f=2*Math.PI*c/a.total,g=2*Math.PI*(c+d)/a.total,h=Math.min(2*Math.PI*.999,Math.abs(g-f));g=f+h;var i=h>Math.PI?1:0;return c+=d,{large:i,start:{x:a.center.x+a.radius*Math.sin(f),y:a.center.y-a.radius*Math.cos(f)},end:{x:a.center.x+a.radius*Math.sin(g),y:a.center.y-a.radius*Math.cos(g)},color:b.colors[e]}}).filter(function(a,c){return b.values[c]>0}).value()}})}]).directive("pieChart",[function(){return{restrict:"E",templateUrl:"partials/directives/pieChart.html",scope:{values:"=pieValues"},controller:"pieChartCtrl",link:function(a,b){a.width=b[0].querySelector(".pie-container").offsetWidth>>0,a.height=a.width}}}]),angular.module("jlogApp.directives").directive("sortBy",["battle_sort",function(a){return{restrict:"A",transclude:!0,scope:{type:"@sortBy"},template:'<span class="clickable" ng-click="sort.sortBy(type)"><span ng-transclude></span><span class="sort-indicator" ng-show="sort.type === type"><span ng-hide="sort.reverse"class="glyphicon glyphicon-collapse-down"></span><span ng-show="sort.reverse"class="glyphicon glyphicon-collapse-up"></span></span></span>',controller:["$scope",function(b){b.sort=a}],link:function(){}}}]),angular.module("jlogApp.directives").controller("stackGraphsCtrl",["$scope",function(a){a.$watch("values",function(b){if(_.exists(b)){var c=a.width/(b.values.length-1);a.legends=_.chain(b.legends).map(function(a,c){return{label:a,color:b.colors[c]}}).value(),a.polygons=_.chain(b.values).map(function(a){return _.reductions(a,function(a,b){return a+b},0)}).apply(function(d){var e=d[0].length;return _.chain(e).range().map(function(a){return _.map(d,function(b){return[_.nth(b,a),_.last(b)]})}).map(function(b){return _.map(b,function(b,d){return[d*c,a.height*(1-b[0]/b[1])]})}).map(function(c,d){return{color:b.colors[d],points:"0,"+a.height+" "+c.join(" ")+" "+a.width+","+a.height}}).value()}).reverse().value()}})}]).directive("stackGraphs",[function(){return{restrict:"E",templateUrl:"partials/directives/stackGraphs.html",scope:{values:"=gphValues"},controller:"stackGraphsCtrl",link:function(a,b){a.width=b[0].querySelector(".gph-container").offsetWidth>>0,a.height=a.width/2}}}]),angular.module("jlogApp.directives").controller("stacksCtrl",["$scope",function(a){a.$watch("values",function(b){if(_.exists(b)){var c=_.reduce(b.values,function(a,b,c){return a[c]=_.reduce(b,function(a,b){return a+b},0),a},{});a.stacks=_.map(b.values,function(d,e){var f=0;return{name:e,layers:_.map(d,function(d,g){var h=a.width*d/c[e],i={x:f,width:h,color:b.colors[g],value:d};return f+=h,i})}})}})}]).directive("stacks",[function(){return{restrict:"E",templateUrl:"partials/directives/stacks.html",scope:{values:"=stacksValues"},controller:"stacksCtrl",link:function(a,b){a.width=.7*(b[0].querySelector("table").offsetWidth>>0),a.height=50}}}]),angular.module("jlogApp.directives").directive("statBar",function(){return{restrict:"A",scope:{statBar:"=",type:"@",percent:"="},template:'<div class="bar bar-win" style="width:{{percent.win[type]}}%;"> {{statBar.win[type] ? statBar.win[type] : ""}} </div><div class="bar bar-draw" style="width:{{percent.draw[type]}}%;"> {{statBar.draw[type] ? statBar.draw[type] : ""}} </div><div class="bar bar-loss" style="width:{{percent.loss[type]}}%;"> {{statBar.loss[type] ? statBar.loss[type] : ""}} </div>'}}),angular.module("jlogApp.directives").directive("whenScrolled",function(){return function(a,b,c){var d=b[0],e=function(b){var e=d.getBoundingClientRect();e.bottom===window.innerHeight&&a.$apply(c.whenScrolled)};angular.element(window).bind("scroll load",e)}}),angular.module("jlogApp.filters").filter("battle",["filter",function(a){return function(b,c,d){return c&&_.isArray(b)?b.filter(function(b){return a.match(b,d)}):b}}]),angular.module("jlogApp.filters").filter("capitalise",[function(){return function(a){return"string"==typeof a?a.charAt(0).toUpperCase()+a.slice(1):a}}]),angular.module("jlogApp.filters").filter("initiative",[function(){return function(a){if(!angular.isObject(a)||"string"!=typeof a.won_roll||"string"!=typeof a.started)return"nil";var b="";return b+="true"===a.won_roll?"Won roll, ":"Lost roll, ",b+="true"===a.started?"started game":"chose side"}}]),angular.module("jlogApp.filters").filter("scoreResultColor",[function(){return function(a){return"string"!=typeof a?"":"victory"==a?"text-success":"defeat"==a?"text-danger":"text-warning"}}]).filter("scoreResultClass",[function(){return function(a){var b;switch(a){case"victory":b="text-success";break;case"draw":b="text-warning";break;case"defeat":b="text-danger"}return b}}]).filter("scoreTypeLetter",[function(){return function(a){return"string"==typeof a?a.charAt(0).toUpperCase():a}}]).filter("scoreType",[function(){return function(a){switch(a){case"va":return"Assassination Victory";case"vs":return"Scenario Victory";case"vc":return"Clock Victory";case"vt":return"Tiebreaker Victory";case"dd":return"Dice-down Draw";case"da":return"Assassination Defeat";case"ds":return"Scenario Defeat";case"dc":return"Clock Defeat";case"dt":return"Tiebreaker Defeat"}return""}}]),angular.module("jlogApp.filters").filter("battle",["battle",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]).filter("factions",["factions",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]).filter("scenarios",["scenarios",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]).filter("scores",["scores",function(a){return function(b,c){var d=_.rest(_.rest(arguments));return a[c].apply(null,_.cons(b,d))}}]),_.mixin({apply:function(a,b){var c=_.rest(_.rest(arguments));return b.apply(null,_.cons(a,c))}}),_.mixin({deepExtend:function a(b,c){return _.each(c,function(c,d){void 0!==c&&(!_.isObject(c)||_.isArray(c)||_.isFunction(c)||!_.isObject(b[d])||_.isArray(b[d])||_.isFunction(b[d])?b[d]=c:a(b[d],c))}),b}}),_.mixin({mapWith:function(a,b){var c=_.rest(_.rest(arguments)),d=_.partial.apply(null,_.cat([b,_],c));return _.map(a,d)}}),_.mixin({spy:function(a){var b=_.rest(arguments);return console.log.apply(console,_.cat(b,[a])),a}}),angular.module("jlogApp.services").factory("backup",["$window","$http","$q",function(a,b,c){return a.URL=a.URL||a.webkitURL,{read_result:null,save_url:null,save_name:"battle_list.txt",read:function(b,c,d){var e="function"==typeof c?c:function(a){},f="function"==typeof d?d:function(a){};this.read_result=null;var g=new a.FileReader;g.onload=function(a){var b;try{b=JSON.parse(a.target.result),e(b)}catch(c){f("invalid file")}},g.onerror=function(){f("error reading file")},g.onabort=function(){f("abort reading file")},g.readAsText(b)},generate:function(b){var c=this.save_url;this.save_url=null,null!==c&&a.URL.revokeObjectURL(c);var d=JSON.stringify(b),e=new a.Blob([d],{type:"text/plain"}),f=a.URL.createObjectURL(e),g=new Date;this.save_name="battle_list_"+g.getTime()+".txt",this.save_url=f},upload:function(a){var d=this;return d.upload.id=null,d.upload.status=null,d.upload.msg="Uploading...",b.post("/api/log",{battles:a},{timeout:2e4}).then(function(a){return d.upload.status=!0,d.upload.msg="data uploaded",d.upload.id=a.data.id,a.data},function(a){return d.upload.status=!1,d.upload.msg="upload failure ("+a.status+")",c.reject(a)})},download:function(){var a=this;return a.download.status=null,a.download.msg="Downloading...",b.get("/api/log/"+a.download.id,{timeout:2e4}).then(function(b){return a.download.status=!0,a.download.msg="data downloaded",b.data.battles},function(b){return a.download.status=!1,a.download.msg="download failure ("+b.status+")",c.reject(b)})},statusReset:function(){this.upload.id=null,this.upload.status=null,this.upload.msg=null,this.download.id=null,this.download.status=null,this.download.msg=null}}}]),angular.module("jlogApp.services").factory("battle",[function(){var a={create:function(a){a=_.exists(a)?a:{};var b=new Date;return _.deepExtend({index:0,date:{year:b.getFullYear(),month:b.getMonth()+1,day:b.getDate()},my_army:{faction:null,caster:null},opponent:{name:null,faction:null,caster:null},setup:{size:null,scenario:null,event:null,initiative:{won_roll:null,started:null}},score:null,points:{my_army:{scenario:null,army:null,kill:null},opponent:{scenario:null,army:null,kill:null}},tags:[],comment:null},a)},test:function(a,b,c,d){var e=_.chain(b).shuffle().first().value(),f=_.chain(b).shuffle().first().value();return{index:a,date:{year:_.chain([2012,2014,2013]).shuffle().first().value(),month:_.chain([4,8,9]).shuffle().first().value(),day:_.chain([5,12,19]).shuffle().first().value()},my_army:{faction:e.key,caster:_.chain(e.casters).shuffle().first().value().key},opponent:{name:_.chain(["wood","kevin","fred"]).shuffle().first().value(),faction:f.key,caster:_.chain(f.casters).shuffle().first().value().key},setup:{size:_.chain([15,25,35,50]).shuffle().first().value(),scenario:_.chain(d).shuffle().first().value().key,event:_.chain(["master","amical","wtc"]).shuffle().first().value(),initiative:{won_roll:_.chain(["true","false"]).shuffle().first().value(),started:_.chain(["true","false"]).shuffle().first().value()}},score:_.chain(c).keys().shuffle().first().value(),points:{my_army:{scenario:5*Math.random()>>0,army:50*Math.random()>>0,kill:50*Math.random()>>0},opponent:{scenario:5*Math.random()>>0,army:50*Math.random()>>0,kill:50*Math.random()>>0}},tags:["tiers4","raek spam"],comment:"don't panic"}},addTag:function(a,b){return _.chain(a).clone().apply(function(a){return a.tags=_.chain(a.tags).cat(b).uniq().sort().value(),a}).value()},initRollDescFor:function(a){return"true"===_.getPath(a,"setup.initiative.won_roll")?"Won Roll":"Lost Roll"},initStartDescFor:function(a){return"true"===_.getPath(a,"setup.initiative.started")?"Started Game":"Chose Side"}};return a}]).service("battles",["$http","$q","battle","orderByFilter",function(a,b,c,d){var e,f={date:function(a){return a.date.year+"-"+a.date.month+"-"+a.date.day},my_faction:"my_army.faction",my_caster:"my_army.caster",opponent:"opponent.name",opponent_faction:"opponent.faction",opponent_caster:"opponent.caster",size:"setup.size",scenario:"setup.scenario",event:"setup.event",initiative:function(a){return("true"===a.setup.initiative.won_roll?"wonRoll":"lostRoll")+"-"+("true"===a.setup.initiative.started?"startedGame":"choseSide")},result:"score",my_cp:"points.my_army.scenario",my_ap:"points.my_army.army",my_kp:"points.my_army.kill",opponent_cp:"points.opponent.scenario",opponent_ap:"points.opponent.army",opponent_kp:"points.opponent.kill",tags:function(a){return a.tags.join("|")},comment:"comment"},g={buildIndex:function(a){return _.each(a,function(a,b){a.index=b})},save:function(a,b,c){var d=_.clone(a);return d.splice(b,1,c),d},drop:function(a,b){var c=_.clone(a);return c.splice(b,1),c},test:function(a,b,d,e){return _.chain(a).range().map(_.partial(c.test,_,b,d,e)).value()},sortTypes:function(){return _.exists(e)?e:a.get("data/sorts.json").then(function(a){return e=a.data},function(a){return b.reject(a)})},updateSortBy:function(a,b,c){if(!_.exists(a[c]))return b;var d=_.clone(b);return d.type===c?d.reverse=!d.reverse:(d.type=c,d.reverse=a[c].reverse),d},sort:function(a,b,c,e){return d(a,b[c].key,e)},toTable:function(a){return _.cat([_.keys(f)],_.chain(a).map(function(a){return _.reduce(f,function(b,c){return b.push(_.isFunction(c)?c(a):_.getPath(a,c)),b},[])}).value())}};return g}]),angular.module("jlogApp.services").service("battles_display",["battles","battleFilter","orderByFilter",function(a,b,c){function d(){var a=this.sorted_list.slice(this.last_index,this.last_index+this.slice);this.display_list=this.display_list.concat(a),this.last_index+=this.slice,this.more=this.last_index<this.sorted_list.length}function e(a,d,e){this.sorted_list=b(this.list,a,d),this.sorted_list=c(this.sorted_list,e.types[e.type].key,e.reverse)}return _.extend(a,{sorted_list:[],display_list:[],slice:15,last_index:0,more:!1,reset:function(a,b,c){this.sorted_list=[],this.display_list=[],this.slice=15,this.last_index=0,this.more=!1,e.call(this,a,b,c),d.call(this)},showMore:function(){this.more&&d.call(this)}}),a}]),angular.module("jlogApp.services").factory("bbStringifier",[function(){function a(a,b){return"["+b+"]"+a+"[/"+b+"]"}var b="\r\n",c={stringify:function(c){return _.chain(c).map(function(b,c){return _.chain(b).map(function(b){return 0===c?a(b,"b"):b}).mapWith(a,"td").join("").apply(a,"tr").value()}).join(b).apply(a,"table").value()}};return c}]),angular.module("jlogApp.services").factory("csvStringifier",[function(){var a="\r\n",b={stringify:function(b){return _.chain(b).map(function(a){return a.join(",")}).join(a).value()}};return b}]),angular.module("jlogApp.services").service("events",[function(){var a={fromBattles:function(a){return _.chain(a).mapWith(_.getPath,"setup.event").without(null,void 0).uniq().sort().value()},add:function(a,b){return _.chain(a).cat(b).without(null,void 0).uniq().sort().value()},drop:function(a,b){return _.without(a,b)}};return a}]),angular.module("jlogApp.services").service("export_csv",["battle",function(a){function b(a,c,d){return _.isString(c)||(c=""),_.reduce(a,function(a,e,f){return"$"===f[0]||_.isFunction(e)||(d[f]={},a+=!_.isObject(e)||_.isArray(e)?c+f+",":b(e,c+f+".",d[f])),a},"")}function c(a,b){return _.reduce(b,function(b,d,e){return _.has(a,e)&&(_.isArray(a[e])?(_.each(a[e],function(a){b+=a+"::"}),a[e].length>0&&(b=b.slice(0,b.length-2)),b+=","):b+=_.isObject(a[e])?c(a[e],d):a[e]+","),b},"")}return{generate:function(d){var e="",f={};return e+=b(a({}),"",f)+"\r\n",_.reduce(d,function(a,b){return a+=c(b,f)+"\r\n"},e)}}}]).service("export_bb",["battle",function(a){function b(a,c,d){return _.isString(c)||(c=""),_.reduce(a,function(a,e,f){return"$"===f[0]||_.isFunction(e)||(d[f]={},a+=!_.isObject(e)||_.isArray(e)?"[th]"+c+f+"[/th]":b(e,c+f+".",d[f])),a},"")}function c(a,b){return _.reduce(b,function(b,d,e){return a.hasOwnProperty(e)&&(_.isArray(a[e])?(b+="[td]",_.each(a[e],function(a){b+=a+","}),a[e].length>0&&(b=b.slice(0,b.length-1)),b+="[/td]"):b+=_.isObject(a[e])?c(a[e],d):"[td]"+a[e]+"[/td]"),b},"")}return{generate:function(d){var e="[table]\r\n",f={};return e+="[tr]"+b(a({}),"",f)+"[/tr]\r\n",e+=_.reduce(d,function(a,b){return a+="[tr]"+c(b,f)+"[/tr]\r\n"},""),e+="[/table]\r\n"}}}]).service("export",["$window","export_csv","export_bb",function(a,b,c){function d(b,c){var d=this[b+"_url"];this[b+"_url"]=null,null!==d&&a.URL.revokeObjectURL(d);var e=c(),f=new a.Blob([e],{type:"text/plain"}),g=a.URL.createObjectURL(f);this[b+"_url"]=g}return{name:null,bb_url:null,csv_url:null,json_url:null,generate:function(a){var e=new Date;this.name="battle_list_"+e.getTime(),d.call(this,"bb",function(){return c.generate(a)}),d.call(this,"csv",function(){return b.generate(a)}),d.call(this,"json",function(){return JSON.stringify(a)})}}}]),angular.module("jlogApp.services").factory("factions",["$http","$q",function(a,b){var c,d={data:function(){return _.exists(c)?c:a.get("data/factions.json").then(function(a){return c=_.chain(a.data).map(function(a,b){return{key:b,name:a.name,icon:a.icon,hue:a.hue,casters:_.map(a.casters,function(a,b){var c=d.normaliseCaster(b);return{key:c,name:a.name}})}}).value()},function(a){return b.reject(a)})},normaliseCaster:function(a){if(!angular.isString(a))return null;var b=a.charAt(a.length-1);return("0">b||b>"9")&&(a+="1"),a.toLowerCase()},keyForName:function(a,b){return _.chain(a).where({name:b}).first().getPath("key").value()},nameFor:function(a,b){return _.chain(a).where({key:b}).first().getPath("name").value()},iconFor:function(a,b){return _.chain(a).where({key:b}).first().getPath("icon").apply(function(a){return _.exists(a)?"data/img/"+a:a}).value()},hueFor:function(a,b){return _.chain(a).where({key:b}).first().getPath("hue").value()},castersFor:function(a,b){return _.chain(a).where({key:b}).first().getPath("casters").value()},casterNameFor:function(a,b,c){return _.chain(a).where({key:b}).first().getPath("casters").where({key:c}).first().getPath("name").value()}};return d}]),angular.module("jlogApp.services").factory("jsonStringifier",[function(){var a={stringify:function(a){return JSON.stringify(a,function(a,b){return s.startsWith(a,"$$")?void 0:b})}};return a}]).factory("fileExport",["$window","csvStringifier","bbStringifier","jsonStringifier",function(a,b,c,d){a.URL=a.URL||a.webkitURL;var e={csv:b,bb:c,json:d};return{generate:function(b,c){return _.chain(c).apply(e[b].stringify).apply(function(b){return new a.Blob([b],{type:"text/plain"})}).apply(a.URL.createObjectURL).value()},cleanup:function(b){_.exists(b)&&a.URL.revokeObjectURL(b)}}}]),angular.module("jlogApp.services").factory("jsonParser",[function(){return{parse:function(a){return[JSON.parse(a),[]]}}}]).factory("fileImport",["$window","$q","jsonParser","igParser",function(a,b,c,d){var e={json:c,ig:d};return{read:function(c,d,f){var g=new a.FileReader,h=b.defer();return g.onload=function(a){var b;try{b=e[c].parse(a.target.result,f),h.resolve(b)}catch(d){h.reject(["invalid file : "+d.message])}},g.onerror=function(){h.reject(["error reading file"])},g.onabort=function(){h.reject(["abort reading file"])},g.readAsText(d),h.promise}}}]),angular.module("jlogApp.services").factory("filterMatchSimple",[function(){var a={create:function(a){return _.extend({active:!1,is:"true",value:[]},a)},match:function(a,b,c){var d=_.getPath(b,c),e=_.isEmpty(a.value)||0<=_.indexOf(a.value,d);return"true"===a.is?e:!e}};return a}]).factory("compareDate",[function(){return function(a,b){return a.year>b.year?1:a.year<b.year?-1:a.month>b.month?1:a.month<b.month?-1:a.day>b.day?1:a.day<b.day?-1:0}}]).factory("filterMatchComp",[function(){function a(a,b){switch(a){case"==":return 0===b;case"!=":return 0!==b;case">":return-1===b;case">=":return 1!==b;case"<":return 1===b;case"<=":return-1!==b}return!1}var b={create:function(a,b){return _.deepExtend({active:!1,is:"==",value:b()},a)},match:function(b,c,d,e){var f=_.getPath(c,d),g=e(b.value,f),h=a(b.is,g);return h}};return b}]).factory("filterMatchCaster",[function(){var a={create:function(a){return _.deepExtend({active:!1,is:"true",value:{faction:null,caster:[]}},a)},match:function(a,b,c){var d=_.getPath(b,c),e=a.value.faction===d.faction&&(_.isEmpty(a.value.caster)||0<=_.indexOf(a.value.caster,d.caster));return"true"===a.is?e:!e}};return a}]).factory("filterMatchInitiative",[function(){var a={create:function(a){return _.extend({active:!1,is:"true",value:{won_roll:"",started:""}},a)},match:function(a,b){var c=b.setup.initiative,d=(s.isBlank(a.value.won_roll)||a.value.won_roll===c.won_roll)&&(s.isBlank(a.value.started)||a.value.started===c.started);return"true"===a.is?d:!d}};return a}]).factory("filterMatchTags",[function(){var a={create:function(a){return _.extend({active:!1,is:"any",value:[]},a)},match:function(a,b){if(_.isEmpty(a.value))return!0;if(_.isEmpty(b.tags))return"none"===a.is||"not_all"===a.is;var c=_.map(a.value,function(a){return 0<=_.indexOf(b.tags,a)}),d=_.every(c),e=_.some(c);switch(a.is){case"any":return e;case"all":return d;case"not_all":return!d;case"none":return!e;default:return!1}}};return a}]).factory("filter",["filterMatchSimple","filterMatchComp","filterMatchCaster","filterMatchInitiative","filterMatchTags","compareDate",function(a,b,c,d,e,f){function g(){var a=new Date;return{year:a.getFullYear(),month:a.getMonth()+1,day:a.getDate()}}function h(a){return _.isObject(a)?a:{}}var i=[{key:"date",create:_.partial(b.create,_,g),match:_.partial(b.match,_,_,"date",f)},{key:"my_army",create:c.create,match:_.partial(c.match,_,_,"my_army")},{key:"opp_name",create:a.create,match:_.partial(a.match,_,_,"opponent.name")},{key:"opp_caster",create:c.create,match:_.partial(c.match,_,_,"opponent")},{key:"result",create:a.create,match:_.partial(a.match,_,_,"score")},{key:"scenario",create:a.create,match:_.partial(a.match,_,_,"setup.scenario")},{key:"initiative",create:d.create,match:d.match},{key:"size",create:_.partial(b.create,_,_.always(50)),match:_.partial(b.match,_,_,"setup.size",_.comparator(_.lt))},{key:"event",create:a.create,match:_.partial(a.match,_,_,"setup.event")},{key:"tags",create:e.create,match:e.match}],j={create:function(a){return a=h(a),_.chain(i).reduce(function(b,c){return b[c.key]=c.create(h(a[c.key])),b
},{}).value()},match:function(a,b,c,d){return d=_.exists(d)?d:{},_.exists(d[b.index])||(d[b.index]=_.chain(i).filter(function(b){return _.getPath(a,b.key+".active")}).map(function(b){return[b.match,a[b.key]]}).map(function(a){return a[0](a[1],b)}).every().value()),c?!d[b.index]:d[b.index]},clearCache:function(a,b){return _.exists(b)?_.omit(a,""+b):{}}};return j}]),angular.module("jlogApp.services").factory("igParser",["$q","battle","factions","scenarios",function(a,b,c,d){var e,f,g={0:"dd",1:"va",2:"vs",3:"vt",4:"vt",5:"vt",6:"vt",7:"vc","-1":"da","-2":"ds","-3":"dt","-4":"dt","-5":"dt","-6":"dt","-7":"dc"},h={1:{won_roll:"true",started:"true"},2:{won_roll:"true",started:"false"},3:{won_roll:"false",started:"true"},4:{won_roll:"false",started:"false"}};return{init:function(){a.when(c.data()).then(function(a){e=a}),a.when(d.data()).then(function(a){f=a})},parse:function(a){var i=[],j=_.clone(f),k=_.chain(a).apply(s.lines).map(function(a,f){if(s.isBlank(a))return void 0;var k=_.chain(a.split(",")).mapWith(s.trim,'"').value();if(18!=k.length)return void i.push("line "+(f+1)+": invalid nb of fields ("+k.length+", expected 18)");var l=new Date(parseFloat(k[0])),m=c.keyForName(e,k[1]);_.exists(m)||i.push("line "+(f+1)+": unknown faction "+k[1]);var n=c.keyForName(e,k[4]);_.exists(n)||i.push("line "+(f+1)+": unknown faction "+k[4]);var o=_.getPath(g,k[6]);_.exists(o)||i.push("line "+(f+1)+": unknown score "+k[6]);var p=d.nameFor(j,k[13]);_.exists(p)?p=k[13]:s.isBlank(k[13])?p=null:(j=d.add(j,k[13]),p=k[13]);var q=_.getPath(h,k[16]);return _.exists(q)?q=_.clone(q):(s.isBlank(k[16])||i.push("line "+(f+1)+": unknown initiative "+k[16]),q=void 0),b.create({date:{year:l.getFullYear(),month:l.getMonth()+1,day:l.getDate()},my_army:{faction:m,caster:c.normaliseCaster(k[2])},opponent:{name:k[3],faction:n,caster:c.normaliseCaster(k[5])},score:o,points:{my_army:{scenario:_.isNumeric(k[7])?parseFloat(k[7]):null,army:_.isNumeric(k[8])?parseFloat(k[8]):null,kill:_.isNumeric(k[9])?parseFloat(k[9]):null},opponent:{scenario:_.isNumeric(k[10])?parseFloat(k[10]):null,army:_.isNumeric(k[11])?parseFloat(k[11]):null,kill:_.isNumeric(k[12])?parseFloat(k[12]):null}},setup:{scenario:p,size:_.isNumeric(k[14])?parseFloat(k[14]):null,event:k[15],initiative:q},comment:k[17]})}).without(void 0).spy("ig battles").value();return[k,i]}}}]),angular.module("jlogApp.services").service("opponents",[function(){var a={fromBattles:function(a){return _.chain(a).mapWith(_.getPath,"opponent.name").without(null,void 0).uniq().sort().value()},add:function(a,b){return _.chain(a).cat(b).without(null,void 0).uniq().sort().value()},drop:function(a,b){return _.without(a,b)}};return a}]),angular.module("jlogApp.services").service("scenarios",["$http","$q",function(a,b){var c,d={data:function(){return _.exists(c)?c:a.get("data/scenarios.json").then(function(a){return c=_.chain(a.data).map(function(a,b){return{key:b,name:a.name}}).value(),_.clone(c)},function(a){return b.reject(a)})},fromBattles:function(a){var b=_.clone(c);return _.chain(a).mapWith(_.getPath,"setup.scenario").uniq().without(void 0,null).each(function(a){_.exists(d.nameFor(b,a))||(b=d.add(b,a))}).value(),b},add:function(a,b){return _.chain(a).cat({key:b,name:s.capitalize(b)}).filter(function(a){return _.exists(_.getPath(a,"key"))}).uniq(!1,_.partial(_.getPath,_,"key")).value()},drop:function(a,b){return _.filter(a,function(a){return a.key!==b})},nameFor:function(a,b){return _.chain(a).where({key:b}).first().getPath("name").value()}};return d}]),angular.module("jlogApp.services").factory("scores",["$http","$q",function(a,b){var c,d={data:function(){return _.exists(c)?c:a.get("data/scores.json").then(function(a){return c=a.data,a.data},function(a){return b.reject(a)})},letterFor:function(a,b){return _.getPath(a,b+".letter")},typeFor:function(a,b){return _.getPath(a,b+".type")},resultFor:function(a,b){return _.getPath(a,b+".result")},classFor:function(a,b){return _.getPath(a,b+".class")}};return d}]),angular.module("jlogApp.services").factory("selection",[function(){var a=function(a){var b=!1;return"string"==typeof this.my_army.faction&&0<this.my_army.faction.length&&(b=!0,_.each(this.battles,function(b){a[b].my_army.faction=this.my_army.faction,a[b].my_army.caster=""})),"string"==typeof this.my_army.caster&&0<this.my_army.caster.length&&(b=!0,_.each(this.battles,function(b){a[b].my_army.caster=this.my_army.caster})),b},b=function(a){var b,c=!1;if("string"==typeof this.opponent.name&&0<this.opponent.name.length)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].opponent.name=this.opponent.name;if("string"==typeof this.opponent.faction&&0<this.opponent.faction.length)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].opponent.faction=this.opponent.faction,a[this.battles[b]].opponent.caster="";if("string"==typeof this.opponent.caster&&0<this.opponent.caster.length)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].opponent.caster=this.opponent.caster;return c},c=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].points&&(a[this.battles[b]].points={my_army:{scenario:null,army:null},opponents:{scenario:null,army:null}}),void 0===a[this.battles[b]].points.my_army&&(a[this.battles[b]].points.my_army={scenario:null,army:null}),void 0===a[this.battles[b]].points.opponent&&(a[this.battles[b]].points.opponent={scenario:null,army:null});if("number"==typeof this.points.my_army.scenario)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].points.my_army.scenario=this.points.my_army.scenario;if("number"==typeof this.points.my_army.army)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].points.my_army.army=this.points.my_army.army;if("number"==typeof this.points.opponent.scenario)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].points.opponent.scenario=this.points.opponent.scenario;if("number"==typeof this.points.opponent.army)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].points.opponent.army=this.points.opponent.army;return c},d=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].date&&(a[this.battles[b]].date={year:2e3,month:1,day:1});if("number"==typeof this.date.year)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].date.year=this.date.year;if("number"==typeof this.date.month)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].date.month=this.date.month;if("number"==typeof this.date.day)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].date.day=this.date.day;return c},e=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].setup&&(a[this.battles[b]].setup={scenario:null,event:null,size:null,initiative:{won_roll:null,started:null}});if("string"==typeof this.setup.scenario)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].setup.scenario=this.setup.scenario;return c},f=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].setup&&(a[this.battles[b]].setup={scenario:null,event:null,size:null,initiative:{won_roll:null,started:null}});if("number"==typeof this.setup.size)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].setup.size=this.setup.size;return c},g=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].setup&&(a[this.battles[b]].setup={scenario:null,event:null,size:null,initiative:{won_roll:null,started:null}});if("string"==typeof this.setup.event)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].setup.event=this.setup.event;return c},h=function(a){var b,c=!1;if("string"==typeof this.score)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].score=this.score;return c},i=function(a){var b,c=!1;if(0<this.tags.length)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].tags=this.tags.slice(0);return c},j=function(a){var b,c=!1;if(0<this.tags.length)for(c=!0,b=0;b<this.battles.length;b++){var d;for(d=0;d<this.tags.length;d++)void 0===a[this.battles[b]].tags&&(a[this.battles[b]].tags=[]),0>a[this.battles[b]].tags.indexOf(this.tags[d])&&a[this.battles[b]].tags.push(this.tags[d])}return c},k=function(a){var b;for(b=0;b<this.battles.length;b++)this.my_army.faction=null,this.my_army.caster=null,a[this.battles[b]].my_army.faction=null,a[this.battles[b]].my_army.caster=null},l=function(a){var b;for(b=0;b<this.battles.length;b++)this.opponent.name=null,this.opponent.faction=null,this.opponent.caster=null,a[this.battles[b]].opponent.name=null,a[this.battles[b]].opponent.faction=null,a[this.battles[b]].opponent.caster=null},m=function(a){var b;for(b=0;b<this.battles.length;b++)this.points={my_army:{scenario:null,army:null},opponent:{scenario:null,army:null}},a[this.battles[b]].points={my_army:{scenario:null,army:null},opponent:{scenario:null,army:null}}},n=function(a){var b;for(b=0;b<this.battles.length;b++)this.date={year:null,month:null,day:null},a[this.battles[b]].date={year:2e3,month:1,day:1}},o=function(a){var b;for(b=0;b<this.battles.length;b++)this.setup.scenario=null,a[this.battles[b]].setup.scenario=null},p=function(a){var b;for(b=0;b<this.battles.length;b++)this.setup.size=null,a[this.battles[b]].setup.size=null},q=function(a){var b;for(b=0;b<this.battles.length;b++)this.setup.event=null,a[this.battles[b]].setup.event=null},r=function(a){var b;for(b=0;b<this.battles.length;b++)this.score=null,a[this.battles[b]].score=null},s=function(a){var b;for(b=0;b<this.battles.length;b++)this.tags=[],a[this.battles[b]].tags=[]},t=function(a){var b;for(b=0;b<this.battles.length;b++){var c;for(c=0;c<this.tags.length;c++){var d=a[this.battles[b]].tags.indexOf(this.tags[c]);d>=0&&a[this.battles[b]].tags.splice(d,1)}}};return{full:!1,toggleFull:function(a){var b;for(b=0;b<a.length;b++)a[b].selected=this.full},battles:[],my_army:{},opponent:{},setup:{},tags:[],points:{my_army:{scenario:null,army:null},opponent:{scenario:null,army:null}},reset:function(a){this.full=!1,this.battles=[],this.my_army={},this.opponent={},this.setup={},this.tags=[],this.points={my_army:{scenario:null,army:null},opponent:{scenario:null,army:null}};var b;for(b=0;b<a.length;b++)a[b].selected=!1},remove:function(a){var b;for(this.battles.sort(),b=0;b<this.battles.length;b++)a.splice(this.battles[this.battles.length-b-1],1);var c=0<this.battles.length;return this.battles=[],c},update:function(a){this.battles=a.map(function(a){return a.index})},set:function(k,l){if(0===this.battles.length)return!1;var m=!1;switch(k){case"my_army":m=a.call(this,l);break;case"opponent":m=b.call(this,l);break;case"points":m=c.call(this,l);break;case"date":m=d.call(this,l);break;case"scenario":m=e.call(this,l);break;case"size":m=f.call(this,l);break;case"event":m=g.call(this,l);break;case"score":m=h.call(this,l);break;case"tags":m=i.call(this,l);break;case"addTags":m=j.call(this,l)}return m},unset:function(a,b){if(0===this.battles.length)return!1;var c=!1;switch(a){case"my_army":c=!0,k.call(this,b);break;case"opponent":c=!0,l.call(this,b);break;case"points":c=!0,m.call(this,b);break;case"date":c=!0,n.call(this,b);break;case"scenario":c=!0,o.call(this,b);break;case"size":c=!0,p.call(this,b);break;case"event":c=!0,q.call(this,b);break;case"score":c=!0,r.call(this,b);break;case"tags":c=!0,s.call(this,b);break;case"addTags":c=!0,t.call(this,b)}return c}}}]),angular.module("jlogApp.services").factory("server",["$http",function(a){var b={upload:function(b){return a.post("/api/log",{battles:b},{timeout:2e4}).then(function(a){return[a.data.id,"data uploaded"]},function(a){return[null,"upload failure ("+a.status+")"]})},download:function(b){return a.get("/api/log/"+b,{timeout:2e4}).then(function(a){return[a.data.battles,"data downloaded"]},function(a){return[null,"download failure ("+a.status+")"]})}};return b}]),angular.module("jlogApp.services").value("sort_types",{date:{name:"Date",key:["date.year","date.month","date.day","index"]},my_caster:{name:"My caster",key:["my_army.faction","my_army.caster","index"]},opponent:{name:"Opponent",key:["opponent.name","index"]},opp_caster:{name:"Opp. caster",key:["opponent.faction","opponent.caster","index"]},scenario:{name:"Scenario",key:["setup.scenario","index"]},size:{name:"Size",key:["setup.size","index"]},event:{name:"Event",key:["setup.event","index"]},result:{name:"Result",key:["score","index"]}}).factory("battle_sort",["sort_types",function(a){return{types:a,type:"date",reverse:!0,sortBy:function(a){this.types.hasOwnProperty(a)&&(this.type===a?this.reverse=!this.reverse:(this.type=a,this.reverse=!1))}}}]),angular.module("jlogApp.services").service("statEntryFaction",["factions","$q",function(a,b){var c;return{init:function(){b.when(a.data()).then(function(a){c=a})},reduce:function(b,d,e){var f=_.chain(b).countBy(_.partial(_.getPath,_,e)).reduce(function(b,d,e){return b[a.nameFor(c,e)]=d,b},{}).value(),g=_.chain(c).reduce(function(a,b){return a[b.name]=b.hue,a},{}).value();return{title:d,hues:g,values:f}}}}]).service("statEntryCaster",["factions","$q",function(a,b){var c;return{init:function(){b.when(a.data()).then(function(a){c=a})},reduce:function(b,d,e){var f=_.chain(b).groupBy(_.partial(_.getPath,_,e+".faction")).reduce(function(b,d,f){return b[a.nameFor(c,f)]=_.chain(d).countBy(_.partial(_.getPath,_,e+".caster")).value(),b},{}).value(),g=_.chain(c).reduce(function(a,b){return a[b.name]=b.hue,a},{}).value();return{title:d,hues:g,values:f}}}}]).service("statEntrySimple",[function(){return{reduce:function(a,b,c){return{title:b,values:_.chain(a).countBy(c).value()}}}}]).service("statEntryScenario",["scenarios","$q",function(a,b){var c;return{init:function(){b.when(a.data()).then(function(a){c=a})},reduce:function(b,d){return{title:d,values:_.chain(b).countBy(_.partial(_.getPath,_,"setup.scenario")).reduce(function(b,d,e){return b[a.nameFor(c,e)]=d,b},{}).value()}}}}]).service("statEntryInit",[function(){return{reduce:function(a,b){return{title:b,legends:["Won Roll, Started Game","Won Roll, Chose Side","Lost Roll, Started Game","Lost Roll, Chose Side"],colors:["#4AE34D","#39B03C","#B02817","#E3341D"],values:_.chain(a).reduce(function(a,b){var c=_.getPath(b,"setup.initiative.won_roll"),d=_.getPath(b,"setup.initiative.started");return _.isString(c)&&_.isString(d)&&a[("true"===c?"wr":"lr")+"_"+("true"===d?"sg":"cs")]++,a},{wr_sg:0,wr_cs:0,lr_sg:0,lr_cs:0}).apply(function(a){return[a.wr_sg,a.wr_cs,a.lr_sg,a.lr_cs]}).value()}}}}]).service("statEntryResult",[function(){return{reduce:function(a,b){return{title:b,legends:["Assassination Victory","Clock Victory","Scenario Victory","Tiebreakers Victory","Dice Down Draw","Tiebreakers Defeat","Scenario Defeat","Clock Defeat","Assassination Defeat"],colors:["#91E893","#4AE34D","#39B03C","#3E633F","#E2E345","#63312B","#B02817","#E3341D","#E87263"],values:_.chain(a).reduce(function(a,b){return a[b.score]++,a},{va:0,vc:0,vs:0,vt:0,dd:0,da:0,dc:0,ds:0,dt:0}).apply(function(a){return[a.va,a.vc,a.vs,a.vt,a.dd,a.dt,a.ds,a.dc,a.da]}).value()}}}}]).service("statEntryTimeResult",["battles","$q",function(a,b){var c;return{init:function(){b.when(a.sortTypes()).then(function(a){c=a})},reduce:function(b,d){return{title:d,legends:["Assassination Victory","Clock Victory","Scenario Victory","Tiebreakers Victory","Dice Down Draw","Tiebreakers Defeat","Scenario Defeat","Clock Defeat","Assassination Defeat"],colors:["#91E893","#4AE34D","#39B03C","#3E633F","#E2E345","#63312B","#B02817","#E3341D","#E87263"],values:_.chain(b).apply(a.sort,c,"date",!1).reductions(function(a,b){var c=_.clone(a);return c[b.score]++,c},{va:0,vc:0,vs:0,vt:0,dd:0,da:0,dc:0,ds:0,dt:0}).mapWith(function(a){return[a.va,a.vc,a.vs,a.vt,a.dd,a.dt,a.ds,a.dc,a.da]}).value()}}}}]).service("statEntryPoints",[function(){return{reduce:function(a,b){return{title:b,colors:["#4AE34D","#E3341D"],values:_.chain(a).reduce(function(a,b){return _.isNumber(_.getPath(b,"points.my_army.scenario"))&&_.isNumber(_.getPath(b,"points.opponent.scenario"))&&(a.Scenario[0]+=b.points.my_army.scenario,a.Scenario[1]+=b.points.opponent.scenario,a.Scenario[2]++),_.isNumber(_.getPath(b,"points.my_army.army"))&&_.isNumber(_.getPath(b,"points.opponent.army"))&&(a.Army[0]+=b.points.my_army.army,a.Army[1]+=b.points.opponent.army,a.Army[2]++),_.isNumber(_.getPath(b,"points.my_army.kill"))&&_.isNumber(_.getPath(b,"points.opponent.kill"))&&(a.Kill[0]+=b.points.my_army.kill,a.Kill[1]+=b.points.opponent.kill,a.Kill[2]++),a},{Scenario:[0,0,0],Army:[0,0,0],Kill:[0,0,0]}).reduce(function(a,b,c){return a[c]=[Math.round(b[0]/b[2]*100)/100,Math.round(b[1]/b[2]*100)/100],a},{}).value()}}}}]).service("statEntryTag",["tags",function(a){return{reduce:function(b,c){return{title:c,values:_.chain(b).apply(a.fromBattles).reduce(function(a,c){return a[s.capitalize(c)]=_.filter(b,function(a){return 0<=_.indexOf(a.tags,c)}).length,a},{}).value()}}}}]),angular.module("jlogApp.services").service("statSelectorTotal",[function(){return{sort:function(a){return{Total:a}}}}]).service("statSelectorFaction",["factions","$q",function(a,b){var c;return{init:function(){b.when(a.data()).then(function(a){c=a})},sort:function(b,d){return _.chain(b).groupBy(_.partial(_.getPath,_,d)).reduce(function(b,d,e){return b[a.nameFor(c,e)]=d,b},{}).value()}}}]).service("statSelectorCaster",["factions","$q",function(a,b){var c;return{init:function(){b.when(a.data()).then(function(a){c=a})},sort:function(b,d,e){return _.exists(d)?_.chain(b).filter(function(a){return _.getPath(a,e+".faction")===d}).groupBy(_.partial(_.getPath,_,e+".caster")).reduce(function(b,e,f){return b[a.casterNameFor(c,d,f)]=e,b},{}).value():[]}}}]).service("statSelectorSimple",[function(){return{sort:function(a,b){return _.chain(a).groupBy(b).reduce(function(a,b,c){return a[s.capitalize(c)]=b,a},{}).value()}}}]).service("statSelectorScenario",["scenarios","$q",function(a,b){var c;return{init:function(){b.when(a.data()).then(function(a){c=a})},sort:function(b){return _.chain(b).groupBy(_.partial(_.getPath,_,"setup.scenario")).reduce(function(b,d,e){return b[a.nameFor(c,e)]=d,b},{}).value()}}}]).service("statSelectorInit",[function(){return{sort:function(a){return _.chain(a).filter(function(a){return _.exists(_.getPath(a,"setup.initiative.won_roll"))&&_.exists(_.getPath(a,"setup.initiative.started"))}).groupBy(function(a){return("true"===_.getPath(a,"setup.initiative.won_roll")?"Won Roll":"Lost Roll")+", "+("true"===_.getPath(a,"setup.initiative.started")?"Started Game":"Chose Side")}).value()}}}]).service("statSelectorResult",["scores","$q",function(a,b){var c;return{init:function(){b.when(a.data()).then(function(a){c=a})},sort:function(b){return _.chain(b).groupBy(_.partial(_.getPath,_,"score")).reduce(function(b,d,e){var f=a.resultFor(c,e),g=a.typeFor(c,e);return _.exists(f)&&_.exists(g)&&(b[s.capitalize(a.resultFor(c,e))+" "+s.capitalize(a.typeFor(c,e))]=d),b},{}).value()}}}]).service("statSelectorTag",["tags",function(a){return{sort:function(b){a.fromBattles(b);return _.chain(b).apply(a.fromBattles).reduce(function(a,c){return a[s.capitalize(c)]=_.filter(b,function(a){return 0<=_.indexOf(a.tags,c)}),a},{}).value()}}}]),angular.module("jlogApp.services").service("stats",["statEntryFaction","statEntryCaster","statEntrySimple","statEntryScenario","statEntryInit","statEntryResult","statEntryTimeResult","statEntryPoints","statEntryTag","statSelectorTotal","statSelectorFaction","statSelectorCaster","statSelectorSimple","statSelectorScenario","statSelectorInit","statSelectorResult","statSelectorTag",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r={ENTRIES:{my_faction:{desc:"My Faction",reduce:_.partial(a.reduce,_,_,"my_army.faction")},my_caster:{desc:"My Caster",reduce:_.partial(b.reduce,_,_,"my_army")},opp_name:{desc:"Opp. Name",reduce:_.partial(c.reduce,_,_,_.partial(_.getPath,_,"opponent.name"))},opp_faction:{desc:"Opp Faction",reduce:_.partial(a.reduce,_,_,"opponent.faction")},opp_caster:{desc:"Opp. Caster",reduce:_.partial(b.reduce,_,_,"opponent")},event:{desc:"Event",reduce:_.partial(c.reduce,_,_,_.partial(_.getPath,_,"setup.event"))},scenario:{desc:"Scenario",reduce:d.reduce},size:{desc:"Size",reduce:_.partial(c.reduce,_,_,function(a){return _.getPath(a,"setup.size")+"pts"})},initiative:{desc:"Initiative",reduce:e.reduce},result:{desc:"Result",reduce:f.reduce},result_time:{desc:"Result Over Time",reduce:g.reduce},points:{desc:"Points",reduce:h.reduce},tag:{desc:"Tag",reduce:i.reduce}},SELECTORS:{total:{desc:"Total",sort:j.sort},my_faction:{desc:"My Faction",sort:_.partial(k.sort,_,"my_army.faction")},my_caster:{desc:"My Caster",sort:_.partial(l.sort,_,_,"my_army")},opp_name:{desc:"Opp. Name",sort:_.partial(m.sort,_,_.partial(_.getPath,_,"opponent.name"))},opp_faction:{desc:"Opp. Faction",sort:_.partial(k.sort,_,"opponent.faction")},opp_caster:{desc:"Opp. Caster",sort:_.partial(l.sort,_,_,"opponent")},event:{desc:"Event",sort:_.partial(m.sort,_,_.partial(_.getPath,_,"setup.event"))},scenario:{desc:"Scenario",sort:n.sort},size:{desc:"Size",sort:_.partial(m.sort,_,function(a){return _.getPath(a,"setup.size")+"pts"})},init:{desc:"Initiative",sort:o.sort},result:{desc:"Result",sort:p.sort},tag:{desc:"Tag",sort:q.sort}},init:function(){a.init(),b.init(),d.init(),g.init(),k.init(),l.init(),n.init(),p.init()},generate:function(a,b,c,d,e){return _.has(r.ENTRIES,c)&&_.has(r.SELECTORS,d)?(a=_.clone(a),a[c]=a[c]||{},a[c][d+"."+e]=_.chain(b).apply(r.SELECTORS[d].sort,e).mapWith(r.ENTRIES[c].reduce).sortBy(_.partial(_.getPath,_,"title")).value(),a):a}};return r}]),angular.module("jlogApp.services").factory("storage",["$window",function(a){var b={setItem:function(){return a.localStorage.setItem.apply(a.localStorage,arguments)},getItem:function(){return a.localStorage.getItem.apply(a.localStorage,arguments)},KEYS:{BATTLES:"jlog_battles",OPPONENTS:"jlog_opponents",EVENTS:"jlog_events",SCENARIOS:"jlog_scenarios",TAGS:"jlog_tags",FILTER:"jlog_filter"},clearJLogKeys:function(){_.each(b.KEYS,function(a){b.setItem(a,"")})}};return b}]),angular.module("jlogApp.services").service("tags",[function(){var a={fromBattles:function(a){return _.chain(a).mapWith(_.getPath,"tags").flatten().without(null,void 0).uniq().sort().value()},add:function(a,b){return _.chain(a).cat(b).without(null,void 0).uniq().sort().value()},drop:function(a,b){return _.without.apply(null,_.cat([a],b))}};return a}]);