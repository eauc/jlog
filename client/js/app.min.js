"use strict";angular.module("jlogApp.services",[]).value("version","0.1"),angular.module("jlogApp.filters",[]),angular.module("jlogApp.controllers",[]),angular.module("jlogApp.directives",[]),angular.module("jlogApp",["ui.router","jlogApp.controllers","jlogApp.filters","jlogApp.services","jlogApp.directives"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/battle"),a.state("battle",{url:"/battle",views:{page:{templateUrl:"partials/battle_list.html",controller:"listCtrl"},"bottom-bar@":{templateUrl:"partials/battle_list_menu.html",controller:"listBottomCtrl"}},data:{}}).state("battle.view",{url:"/view/:index",views:{battle:{templateUrl:"partials/battle_view.html",controller:"listViewCtrl"},"bottom-bar@":{templateUrl:"partials/battle_view_menu.html",controller:"listViewBottomCtrl"}},data:{}}).state("battle.edit",{url:"/edit/:index",views:{battle:{templateUrl:"partials/battle_edit.html",controller:"listEditCtrl"},"bottom-bar@":{templateUrl:"partials/battle_edit_menu.html",controller:"listEditBottomCtrl"}},data:{}}).state("filter",{url:"/filter",views:{page:{templateUrl:"partials/filter.html",controller:"filterEditCtrl"},"bottom-bar@":{templateUrl:"partials/filter_menu.html",controller:"filterEditBottomCtrl"}},data:{}}).state("stats",{url:"/stats",views:{page:{templateUrl:"partials/stats.html",controller:"statsCtrl"},"bottom-bar@":{templateUrl:"partials/stats_menu.html",controller:"statsBottomCtrl"}},data:{}}).state("backup",{url:"/backup",views:{page:{templateUrl:"partials/backup.html",controller:"backupCtrl"}}}).state("info",{url:"/info",views:{page:{templateUrl:"partials/info.html"}}})}]).config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|blob):/)}]),angular.module("jlogApp.controllers").controller("backupCtrl",["$scope","backup","battles","storage",function(a,b,c,d){a.bottom_bar.show=!1,a.backup=b,a.readBackupFile=function(c){a.backup.read(c,function(c){d.clearJLogKeys(),a.$emit("newBattles",c),b.generate(a.battles.list),a.$apply("backup.read_result = 'loaded file'")},function(b){a.$apply("backup.read_result = '"+b+"'")})},a.uploadData=function(){b.upload(c.list)},a.downloadData=function(){!_.isString(b.download.id)||0>=b.download.id.length||b.download().then(function(c){d.clearJLogKeys(),a.$emit("newBattles",c),b.generate(a.battles.list)})},a.onClearStorage=function(){d.clearJLogKeys()},b.statusReset(),b.generate(a.battles.list)}]),angular.module("jlogApp.controllers").controller("filterEditCtrl",["$scope","filter",function(a,b){a.bottom_bar.show=!0,a.$watch("filter",function(){b.clearCache(),b.update()},!0)}]).controller("filterEditBottomCtrl",["$scope","$state",function(a,b){a.onBack=function(){b.go(a.filter_state.previous)}}]),angular.module("jlogApp.controllers").controller("listCtrl",["$scope","$state","$timeout","scenarios",function(a,b){a.bottom_bar.show=!0,a.filter_state.previous="battle",a.onViewBattle=function(a){b.go("battle.view",{index:a})},a.resetListDisplay(),a.$watch("sort",a.resetListDisplay,!0),a.show_list=!0,a.$on("$stateChangeSuccess",function(b,c){a.show_list="battle"===c.name})}]).controller("listBottomCtrl",["$scope","$state","export","battles_display",function(a,b,c,d){a.onAddBattle=function(){b.go("battle.edit",{index:-1})},a["export"]=c,a.onExportOpen=function(b){c.generate(d.sorted_list),a.drop_down.toggle("battle_list_export",b)}}]),angular.module("jlogApp.controllers").controller("listEditCtrl",["$scope","$state","$stateParams","$window","battle","battles","opponents","events","scenarios","tags",function(a,b,c,d,e,f,g,h,i,j){a.bottom_bar.show=!0;0>c.index?(b.current.data.index=f.list.length,b.current.data.battle=e()):(b.current.data.index=c.index,b.current.data.battle=angular.copy(f.list[b.current.data.index])),a.battle=b.current.data.battle,b.current.data.save_enable=!1,a.$watch("battle_edit.$valid",function(a){b.current.data.save_enable=a}),a.onAddOpponent=function(){var b=d.prompt("Enter new opponent name :");b=null!==b?b.trim().toLowerCase():"",g.add(b),a.battle.opponent.name=b},a.onAddEvent=function(){var b=d.prompt("Enter new event name :");b=null!==b?b.trim():"",h.add(b),a.battle.setup.event=b},a.onAddScenario=function(){var b=d.prompt("Enter new scenario name :");b=null!==b?b.trim():"";var c=i.add(b);a.battle.setup.scenario=c},a.onAddTag=function(){var b=d.prompt("Enter new tag name :");b=null!==b?b.trim():"",j.add(b),a.battle.addTag(b)};var k={opponent:{get:function(){return angular.isString(this.opponent.name)?this.opponent.name:""},clear:function(){this.opponent.name=null},service:g},event:{get:function(){return angular.isString(this.setup.event)?this.setup.event:""},clear:function(){this.setup.event=null},service:h},scenario:{get:function(){return angular.isString(this.setup.scenario)?this.setup.scenario:""},clear:function(){this.setup.scenario=null},service:i},tags:{get:function(){return this.tags},clear:function(a){for(var b;0<=(b=this.tags.indexOf(a));)this.tags.splice(b,1)},service:j}};a.onDelete=function(b){if(k.hasOwnProperty(b)){var c=k[b].get,e=k[b].clear,g=c.call(a.battle);if(g=null!==g?g:"",!(0>=g.length)){var h=d.confirm('Forget everything about "'+g+'" ?');h&&(e.call(a.battle),f.clear(g,c,e),k[b].service.remove(g))}}},a.onDeleteTag=function(){var b=a.battle.tags;if(!(b.length<=0)){var c="Forget everything about these tags ?\r\n";_.each(b,function(a){c+="	"+a+"\r\n"});var e=d.confirm(c);e&&(a.battle.tags=[],_.each(b,function(a){f.clear(a,k.tags.get,k.tags.clear),j.remove(a)}))}}}]).controller("listEditBottomCtrl",["$scope","$state","battles","filter",function(a,b,c,d){a.state=b.current.data,a.onSave=function(){c.save(b.current.data.index,b.current.data.battle),d.clearCache(b.current.data.index),a.resetListDisplay(),a.onClose()},a.onClose=function(){b.go("battle")}}]),angular.module("jlogApp.controllers").controller("listViewCtrl",["$scope","$state","$stateParams","$window","battles",function(a,b,c,d,e){a.bottom_bar.show=!0,void 0===c.index&&b.go("battle"),a.battle=e.list[c.index]}]).controller("listViewBottomCtrl",["$scope","$state","$stateParams","$window","battles",function(a,b,c,d,e){a.onEditBattle=function(){b.go("battle.edit",{index:c.index})},a.onDeleteBattle=function(){var b=d.confirm("You sure you wanna delete this battle ?");b&&(e.remove(c.index),a.resetListDisplay(),a.onClose())},a.onClose=function(){b.go("battle")}}]),angular.module("jlogApp.controllers").controller("mainCtrl",["$scope","$timeout","$state","factions","opponents","events","scenarios","tags","scores","battles_display","battle_sort","filter",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){a.battles.showMore(),a.battles.more&&b(m,100)}j.init(),e.init(j.list),f.init(j.list),g.init(j.list),h.init(j.list),l.init(),a.battles=j,a.factions=d,a.scores=i,a.filter_state={active:!1,invert:!1,previous:"battle"},a.filter=l.list,a.sort=k,a.opponents=e.list,a.scenarios=g.list,a.events=f.list,a.tags=h.list,a.$on("newBattles",function(b,c){j.create(c),e.create(a.battles.list),f.create(a.battles.list),g.create(a.battles.list),h.create(a.battles.list),a.opponents=e.list,a.scenarios=g.list,a.events=f.list,a.tags=h.list}),a.bottom_bar={show:!1},a.drop_down={state:null,toggle:function(a,b){this.state=this.state===a?null:a,b.stopPropagation()},clear:function(){this.state=null},active:function(a){return this.state===a}},a.stateIs=function(a){return c.is(a)},a.resetListDisplay=function(){a.battles.reset(a.filter_state.active,a.filter_state.invert,a.sort),a.$broadcast("battles_reset"),b(m,100)},a.setFilterActive=function(b){var c=a.filter_state.active!=b;a.filter_state.active=b,c&&a.resetListDisplay()},a.setFilterInvert=function(b){var c=a.filter_state.invert!=b;a.filter_state.invert=b,c&&a.resetListDisplay()}}]),angular.module("jlogApp.controllers").controller("statsCtrl",["$scope","$state","stats",function(a,b,c){a.bottom_bar.show=!0,a.filter_state.previous="stats",a.resetListDisplay(),b.current.data.state={entry:"result",selector:"my_caster",setEntry:function(a){this.entry=a,this.doGenerate()},setSelector:function(a){this.selector!=a&&(d=null),this.selector=a,this.doGenerate()},doGenerate:function(){c.generate(this.entry,this.selector)}},a.stats=c,a.stats.collections={},a.state=b.current.data.state,a.state.doGenerate(),a.$on("battles_reset",function(){c.collections={},a.state.doGenerate()});var d=null;a.doShow=function(a){d=a},a.show=function(a){return d==a}}]).controller("statsBottomCtrl",["$scope","$state","stats",function(a,b,c){a.stats=c,a.state=b.current.data.state}]),angular.module("jlogApp.directives").factory("appCache",["$window","$rootScope",function(a){function b(a){var b="progress"===a.type;c.progress=b?(c.progress+1)%100:0,c.onProgress(b)}var c={progress:0,onProgress:function(){},onUpdateReady:function(){}},d=a.applicationCache;return d.addEventListener("cached",b,!1),d.addEventListener("checking",b,!1),d.addEventListener("downloading",b,!1),d.addEventListener("error",b,!1),d.addEventListener("noupdate",b,!1),d.addEventListener("obsolete",b,!1),d.addEventListener("progress",b,!1),d.addEventListener("updateready",function(a){d.status===d.UPDATEREADY&&c.onUpdateReady(),c.progress=0,c.onProgress(!1)},!1),c}]).directive("appCacheProgressBar",function(){return{restrict:"E",template:'<div class="appcache-progress"     ng-show="appCache.progress != 0">  <div class="appcache-progress-bar"       ng-style="{\'width\': appCache.progress + \'%\' }"></div></div>',controller:["$scope","$window","appCache",function(a,b,c){a.appCache=c,c.onProgress=function(){a.$apply()},c.onUpdateReady=function(){b.confirm("A new version of this site is available. Load it?")&&b.location.reload()}}],link:function(){}}}),angular.module("jlogApp.directives").directive("collapse",function(){return{restrict:"A",link:function(a,b,c){a.$watch(c.collapse,function(a){a?b.addClass("collapse"):b.removeClass("collapse")})}}}),angular.module("jlogApp.directives").directive("exportLink",function(){return{restrict:"A",transclude:!0,scope:{name:"@",type:"@",source:"="},template:'<a> </a> <a class="clickable" ng-click="exportSource()" ng-transclude> </a>',controller:["$scope","$window",function(a,b){a.file_url=null,a.file_name=a.name+"."+a.type,a.exportSource=function(){var c=a.source["export"](a.type),d=a.file_url;a.file_url=null,null!==d&&b.URL.revokeObjectURL(d);var e=new b.Blob([c],{type:"text/plain"});b.URL=b.URL||b.webkitURL;var f=b.URL.createObjectURL(e);a.file_url=f;var g=new Date;a.file_name=a.name+"_"+g.getTime()+"."+a.type,a.launchDownload()}}],link:function(a,b){var c=b.find("a")[0];a.launchDownload=function(){c.href=a.file_url,c.download=a.file_name,c.click()}}}}),angular.module("jlogApp.directives").directive("pieChart",["$timeout",function(){function a(a,b,c){var d=document.createElementNS(k,"svg");return d.style.width=b+"px",d.style.height=c+"px",d.style.display="inline-block",a.appendChild(d),d}function b(a){var b=document.createElement("div");return b.style.display="inline-block",b.style.verticalAlign="top",b.style.textAlign="left",b.style.paddingLeft="10px",a.appendChild(b),b}function c(a,b){for(;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)b.removeChild(b.firstChild)}function d(a){return _.reduce(a,function(a,b){return a+(_.isNumber(b)?b:0)},0)}function e(a,b,c){var d=[],e=0;return _.each(a,function(a,f){_.isNumber(a)&&a>0&&(d.push({value:a,color:_.isObject(b)?b[f]:j[e%j.length],legend:_.isObject(c)?c[f]:f}),e++)}),d}function f(a,b,c,d){var e=document.createElementNS(k,"circle");e.setAttributeNS(null,"style","stroke: #fff; stroke-width:1.5; fill:"+d.color+";"),e.setAttributeNS(null,"cx",b/2+""),e.setAttributeNS(null,"cy",c/2+""),e.setAttributeNS(null,"r",b/2+""),a.appendChild(e)}function g(a,b,c,d,e,f){var g=2*f.value*Math.PI/d;e.angle+=g;var h=b/2+b/2*Math.sin(e.angle),i=c/2-c/2*Math.cos(e.angle),j=g>=Math.PI?1:0,l=document.createElementNS(k,"path");l.setAttributeNS(null,"style","stroke: #fff; stroke-width:1.5; fill:"+f.color+";"),l.setAttributeNS(null,"d","M"+b/2+","+c/2+" L"+e.portion[0]+","+e.portion[1]+" A"+b/2+","+c/2+" 0 "+j+",1 "+h+","+i+" Z"),a.appendChild(l),e.portion=[h,i]}function h(a,b){var c=document.createElement("div");c.innerHTML='<span style="background-color:'+b.color+';border-radius:1em;width:0.75em;height:0.75em;display:inline-block;vertical-align:middle;">&nbsp;</span> '+b.legend,a.appendChild(c)}function i(a,b,c,i,j){var k=_.isObject(a.values);if(k){var l=null;_.isObject(a.options)&&_.isFunction(a.options.colors)&&(l=a.options.colors(a.values));var m=null;_.isObject(a.options)&&_.isFunction(a.options.legends)&&(m=a.options.legends(a.values));var n=d(a.values),o=e(a.values,l,m);if(1==o.length)return void f(b,i,j,o[0]);var p={angle:0,portion:[i/2,0]};_.each(o,function(a){g(b,i,j,n,p,a),h(c,a)})}}var j=["#2f69bf","#a2bf2f","#bf5a2f","#bfa22f","#772fbf","#bf2f2f","#00327f","#667f00"],k="http://www.w3.org/2000/svg";return{restrict:"A",scope:{values:"=",options:"="},link:function(d,e,f){var g=f.width>>0,h=f.height>>0,j=a(e[0],g,h),k=b(e[0]);i(d,j,k,g,h),d.$watch("values",function(){c(j,k),i(d,j,k,g,h)})}}}]),angular.module("jlogApp.directives").directive("sortBy",["battle_sort",function(a){return{restrict:"A",transclude:!0,scope:{type:"@sortBy"},template:'<span class="clickable" ng-click="sort.sortBy(type)"><span ng-transclude></span><span class="sort-indicator" ng-show="sort.type === type"><span ng-hide="sort.reverse"class="glyphicon glyphicon-collapse-down"></span><span ng-show="sort.reverse"class="glyphicon glyphicon-collapse-up"></span></span></span>',controller:["$scope",function(b){b.sort=a}],link:function(){}}}]),angular.module("jlogApp.directives").directive("statBar",function(){return{restrict:"A",scope:{statBar:"=",type:"@",percent:"="},template:'<div class="bar bar-win" style="width:{{percent.win[type]}}%;"> {{statBar.win[type] ? statBar.win[type] : ""}} </div><div class="bar bar-draw" style="width:{{percent.draw[type]}}%;"> {{statBar.draw[type] ? statBar.draw[type] : ""}} </div><div class="bar bar-loss" style="width:{{percent.loss[type]}}%;"> {{statBar.loss[type] ? statBar.loss[type] : ""}} </div>'}}),angular.module("jlogApp.directives").directive("whenScrolled",function(){return function(a,b,c){var d=b[0],e=function(b){var e=d.getBoundingClientRect();e.bottom===window.innerHeight&&a.$apply(c.whenScrolled)};angular.element(window).bind("scroll load",e)}}),angular.module("jlogApp.filters").filter("battle",["filter",function(a){return function(b,c,d){return c&&_.isArray(b)?b.filter(function(b){return a.match(b,d)}):b}}]),angular.module("jlogApp.filters").filter("capitalise",[function(){return function(a){return"string"==typeof a?a.charAt(0).toUpperCase()+a.slice(1):a}}]),angular.module("jlogApp.filters").filter("initiative",[function(){return function(a){if(!angular.isObject(a)||"string"!=typeof a.won_roll||"string"!=typeof a.started)return"nil";var b="";return b+="true"===a.won_roll?"Won roll, ":"Lost roll, ",b+="true"===a.started?"started game":"chose side"}}]),angular.module("jlogApp.filters").filter("scoreResultColor",[function(){return function(a){return"string"!=typeof a?"":"victory"==a?"text-success":"defeat"==a?"text-danger":"text-warning"}}]).filter("scoreTypeLetter",[function(){return function(a){return"string"==typeof a?a.charAt(0).toUpperCase():a}}]).filter("scoreType",[function(){return function(a){switch(a){case"va":return"Assassination Victory";case"vs":return"Scenario Victory";case"vc":return"Clock Victory";case"vt":return"Tiebreaker Victory";case"dd":return"Dice-down Draw";case"da":return"Assassination Defeat";case"ds":return"Scenario Defeat";case"dc":return"Clock Defeat";case"dt":return"Tiebreaker Defeat"}return""}}]),angular.module("vassalApp.controllers").controller("gameCtrl",["$scope","$state","$stateParams","$http","$q","$window","game","command","message","factions",function(a,b,c,d,e,f,g,h,i,j){var k={name:"Default","Alt B":function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_blind;a.game.newCommand(h("onSelection","toggle","blind",b))}},"Atl C":function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_corrosion;a.game.newCommand(h("onSelection","toggle","corrosion",b))}},"Ctrl C":function(){if(a.game.selection.length>0){a.create_model_preview.info=[];var b=a.game.models[a.game.selection[0]].state.x,c=a.game.models[a.game.selection[0]].state.y;a.create_model_preview.x=b+10,a.create_model_preview.y=c+10,_.each(a.game.selection,function(d){var e=a.game.models[d].state.x-b,f=a.game.models[d].state.y-c;a.create_model_preview.info.push({info:a.game.models[d].info,offset_x:e,offset_y:f})}),a.current_mode=m}},"Shift C":function(){1===a.game.selection.length&&(a.game.models[a.game.selection[0]].info.focus||a.game.models[a.game.selection[0]].info.fury)&&a.game.newCommand(h("onSelection","toggleControl"))},"Ctrl E":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","setRotation",90))},F:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","focus"))},"Alt F":function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_fire;a.game.newCommand(h("onSelection","toggle","fire",b))}},I:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","image"))},"Alt I":function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_incorporeal;a.game.newCommand(h("onSelection","toggle","incorporeal",b))}},"Alt K":function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_kd;a.game.newCommand(h("onSelection","toggle","kd",b))}},"Shift L":function(){a.los_drag.state=null,a.current_mode=t},M:function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_melee;a.game.newCommand(h("onSelection","toggle","melee",b))}},"Ctrl N":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","setRotation",0))},"Alt P":function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_leader;a.game.newCommand(h("onSelection","toggle","leader",b))}},R:function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_reach;a.game.newCommand(h("onSelection","toggle","reach",b))}},"Shift R":function(){a.current_mode=v},"Alt S":function(){if(a.game.selection.length>0){var b=!a.game.models[a.game.selection[0]].state.show_stationary;a.game.newCommand(h("onSelection","toggle","stationary",b))}},"Ctrl S":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","setRotation",180))},T:function(){a.current_mode=o},U:function(){a.game.newCommand(h("setSelection",[]))},"Ctrl W":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","setRotation",270))},"Ctrl W":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","setRotation",270))},"Ctrl Z":function(){a.game.undoLastCommand()},"Alt 0":function(){a.game.board.reset()},"Ctrl 0":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","color",!1))},"Ctrl 1":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","color","#0FF"))},"Ctrl 2":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","color","#F0F"))},3:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggleAoe",3))},"Ctrl 3":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","color","#FF0"))},4:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggleAoe",4))},"Ctrl 4":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","color","#00F"))},5:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggleAoe",5))},"Ctrl 5":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","color","#0F0"))},"Ctrl 6":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","toggle","color","#F00"))},Delete:function(){a.game.newCommand(h("dropSelection"))},Add:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","incrementFocus"))},"Alt Add":function(){a.game.board.zoomIn()},Substract:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","decrementFocus"))},"Alt Substract":function(){a.game.board.zoomOut()},Left:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","rotateLeft",!1))},"Shift Left":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","rotateLeft",!0))},"Alt Left":function(){a.game.board.moveLeft()},"Ctrl Left":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveLeft",!1))},"Ctrl Shift Left":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveLeft",!0))},Down:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveBack",!1))},"Shift Down":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveBack",!0))},"Alt Down":function(){a.game.board.moveDown()},"Ctrl Down":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveDown",!1))},"Ctrl Shift Down":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveDown",!0))},Right:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","rotateRight",!1))},"Shift Right":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","rotateRight",!0))},"Alt Right":function(){a.game.board.moveRight()},"Ctrl Right":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveRight",!1))},"Ctrl Shift Right":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveRight",!0))},Up:function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveFront",!1))},"Shift Up":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveFront",!0))},"Alt Up":function(){a.game.board.moveUp()},"Ctrl Up":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveUp",!1))},"Ctrl Shift Up":function(){a.game.selection.length>0&&a.game.newCommand(h("onSelection","moveUp",!0))},DragStart:function(b,c){switch(c.event){case"Template":a.game.templates.active=c.target,c.target.startDraging(),a.current_mode=q;break;case"Model":0<=_.indexOf(a.game.selection,c.target.state.id)&&(a.game.onSelection("startDraging"),n.length=0,a.current_mode=n);break;case"Board":a.selection.width=0,a.selection.height=0,a.current_mode=l}},Click:function(b,c){"Model"===c.event&&(a.game.newCommand(b.ctrlKey?0<=_.indexOf(a.game.selection,c.target.state.id)?h("removeFromSelection",[c.target.state.id]):h("addToSelection",[c.target.state.id]):h("setSelection",[c.target.state.id])),a.game.selection.length>0&&(a.model_label=a.game.models[a.game.selection[0]].state.label))}},l={name:"Selection Drag",Drag:function(b,c,d,e,f,g){a.selection.x=c.start_x,a.selection.width=f,a.selection.width<0&&(a.selection.width=-a.selection.width,a.selection.x=a.selection.x-a.selection.width),a.selection.y=c.start_y,a.selection.height=g,a.selection.height<0&&(a.selection.height=-a.selection.height,a.selection.y=a.selection.y-a.selection.height)},DragEnd:function(b){if(this.Drag.call(this,arguments),a.selection.width>0&&a.selection.height>0){var c=[];_.each(a.game.models,function(b){var d=b.state.x,e=b.state.y;a.selection.x<=d&&d<=a.selection.x+a.selection.width&&a.selection.y<=e&&e<=a.selection.y+a.selection.height&&c.push(b.state.id)}),b.ctrlKey?(a.game.newCommand(h("addToSelection",c)),a.game.selection.length>0&&(a.model_label=a.game.models[a.game.selection[0]].state.label)):(a.game.newCommand(h("setSelection",c)),a.game.selection.length>0&&(a.model_label=a.game.models[a.game.selection[0]].state.label))}a.selection.width=0,a.selection.height=0,a.current_mode=k}},m={name:"Model Create",MouseMove:function(b,c,d){a.create_model_preview.x=c,a.create_model_preview.y=d},Click:function(b,c,d,e){var f=[];_.each(a.create_model_preview.info,function(a){f.push({info:a.info,x:d+a.offset_x,y:e+a.offset_y,show_leader:a.show_leader})}),a.game.newCommand(h("createModel",f)),a.current_mode=k}},n={name:"Model Drag",Drag:function(b,c,d,e,f,g){a.game.onSelection("draging",f,g),this.length=(10*Math.sqrt(f*f+g*g)>>0)/100},DragEnd:function(b,c,d,e,f,g){a.game.newCommand(h("endDragingSelection",f,g)),a.current_mode=k}},o={name:"Model Target",Click:function(b,c){"Model"!==c.event||c.target.state.active||(a.game.newCommand(h("onSelection","alignWith",c.target.state.x,c.target.state.y)),a.current_mode=k)}},p={name:"Template",D:function(){"aoe"!==a.game.templates.active.type||a.game.templates.active.locked||a.doAoEDeviation()},L:function(){a.game.newCommand(h("onActiveTemplate","toggleLocked"))},O:function(){a.game.templates.active.locked||(a.current_mode=r)},"Shift R":function(){if(a.game.ruler.state.active&&!a.game.templates.active.locked){var b=a.game.ruler.model_end?a.game.ruler.model_end.state.x:a.game.ruler.state.x2,c=a.game.ruler.model_end?a.game.ruler.model_end.state.y:a.game.ruler.state.y2,d=180*Math.atan2(a.game.ruler.state.x2-a.game.ruler.state.x1,-(a.game.ruler.state.y2-a.game.ruler.state.y1))/Math.PI;a.game.newCommand(h("onActiveTemplate","set",b,c,d))}},T:function(){a.game.templates.active.locked||(a.current_mode=s)},0:function(){"spray"!==a.game.templates.active.type||a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","toggleSize",10))},3:function(){"aoe"!==a.game.templates.active.type||a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","toggleSize",3))},4:function(){"aoe"!==a.game.templates.active.type||a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","toggleSize",4))},5:function(){"aoe"!==a.game.templates.active.type||a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","toggleSize",5))},6:function(){"spray"!==a.game.templates.active.type||a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","toggleSize",6))},8:function(){"spray"!==a.game.templates.active.type||a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","toggleSize",8))},Delete:function(){a.game.newCommand(h("deleteActiveTemplate"))},Up:function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveFront",!1))},"Shift Up":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveFront",!0))},"Ctrl Up":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveUp",!1))},"Ctrl Shift Up":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveUp",!0))},Left:function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","rotateLeft",!1))},"Shift Left":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","rotateLeft",!0))},"Ctrl Left":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveLeft",!1))},"Ctrl Shift Left":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveLeft",!0))},Right:function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","rotateRight",!1))},"Shift Right":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","rotateRight",!0))},"Ctrl Right":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveRight",!1))},"Ctrl Shift Right":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveRight",!0))},Down:function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveBack",!1))},"Shift Down":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveBack",!0))},"Ctrl Down":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveDown",!1))},"Ctrl Shift Down":function(){a.game.templates.active.locked||a.game.newCommand(h("onActiveTemplate","moveDown",!0))},DragStart:function(b,c){"Template"===c.event&&(a.game.templates.active=c.target,c.target.startDraging(),a.current_mode=q)},Click:function(b,c){switch(c.event){case"Template":a.game.templates.active===c.target?(a.game.templates.active=null,a.current_mode=k):a.game.templates.active=c.target;break;case"Model":a.current_mode=k,a.current_mode.Click.call(arguments)}}},q={name:"Template Drag",Drag:function(b,c,d,e,f,g){a.game.templates.active.draging(a.game,f,g)},DragEnd:function(b,c,d,e,f,g){a.game.newCommand(h("dragActiveTemplate",f,g)),a.game.templates.active=c.target,a.current_mode=p}},r={name:"Template Origin",Click:function(b,c){if("Model"===c.event){var d=c.target,e=a.game.templates.active;if("aoe"===e.type){var f=d.state.x,g=d.state.y,i=e.x,j=e.y,k=180*Math.atan2(i-f,g-j)/Math.PI;a.game.newCommand(h("onActiveTemplate","set",e.x,e.y,k))}else{e.origin=d;var l=d.state.x+d.info.r*Math.sin(e.rot*Math.PI/180),m=d.state.y-d.info.r*Math.cos(e.rot*Math.PI/180);a.game.newCommand(h("onActiveTemplate","set",l,m,e.rot))}a.current_mode=p}}},s={name:"Template Target",Click:function(b,c){if("Model"===c.event){var d,e,f=c.target,g=a.game.templates.active;if("aoe"===g.type)d=f.state.x,e=f.state.y,a.game.newCommand(h("onActiveTemplate","set",d,e,a.game.templates.active.rot));else{if(g.origin===f)return;var i=g.origin?g.origin.state.x:g.x,j=g.origin?g.origin.state.y:g.y,k=f.state.x,l=f.state.y,m=180*Math.atan2(k-i,j-l)/Math.PI;d=null===g.origin?g.x:g.origin.state.x+g.origin.info.r*Math.sin(m*Math.PI/180),e=null===g.origin?g.y:g.origin.state.y-g.origin.info.r*Math.cos(m*Math.PI/180),a.game.newCommand(h("onActiveTemplate","set",d,e,m))}a.current_mode=p}}},t={name:"LoS","Shift L":function(){a.game.los.state.active&&a.game.newCommand(h("onLos","setActive",!1)),a.current_mode=k},DragStart:function(b,c,d,e){a.game.los.startDraging(d,e),a.current_mode=u}},u={name:"LoS Drag",Drag:function(b,c,d,e){a.game.los.setEnd(d,e)},DragEnd:function(b,c,d,e){a.game.newCommand(h("onLos","endDraging",d,e)),a.current_mode=t}},v={name:"Ruler",O:function(){a.current_mode=x},T:function(){a.current_mode=y},DragStart:function(b,c){this.origin=null,this.target=null,a.game.ruler.startDraging(c.start_x,c.start_y),a.show_ruler=!0,a.current_mode=w}},w={name:"Ruler Drag",Drag:function(b,c,d,e,f,g){var h=Math.sqrt(f*f+g*g),i=h;a.game.ruler.state.range>0&&(i=Math.min(10*a.game.ruler.state.range,h));var j=a.game.ruler.state.x1+(d-a.game.ruler.state.x1)*i/h,k=a.game.ruler.state.y1+(e-a.game.ruler.state.y1)*i/h;a.game.ruler.setEnd(j,k)},DragEnd:function(b,c,d,e,f,g){var h=Math.sqrt(f*f+g*g),i=h;a.game.ruler.state.range>0&&(i=Math.min(10*a.game.ruler.state.range,h));var j=a.game.ruler.state.x1+(d-a.game.ruler.state.x1)*i/h,k=a.game.ruler.state.y1+(e-a.game.ruler.state.y1)*i/h;a.game.ruler.endDraging(j,k),a.current_mode=v}},x={name:"Ruler Origin",ModelClick:function(b,c){a.ruler_drag.origin=c,a.game.ruler.setStart(c.state.x,c.state.y),a.game.ruler.state.active=!1,a.ruler_drag.target=null,a.game.ruler.sendStateCmd()}},y={name:"Ruler Target",ModelClick:function(b,c){if(a.ruler_drag.origin!==c){a.ruler_drag.target=c;var d=a.game.ruler,e=d.state.x1,f=d.state.y1,g=c.state.x,h=c.state.y;a.ruler_drag.origin&&(e=a.ruler_drag.origin.state.x,f=a.ruler_drag.origin.state.y);var i=Math.atan2(g-e,f-h);a.ruler_drag.origin&&(e+=a.ruler_drag.origin.info.r*Math.sin(i),f-=a.ruler_drag.origin.info.r*Math.cos(i)),g-=c.info.r*Math.sin(i),h+=c.info.r*Math.cos(i);var j=g-e,k=h-f,l=Math.sqrt(j*j+k*k),m=l;a.game.ruler.state.range>0&&(m=Math.min(10*a.game.ruler.state.range,l)),g=e+(g-e)*m/l,h=f+(h-f)*m/l,a.game.ruler.setStart(e,f),a.game.ruler.setEnd(g,h),a.game.ruler.refresh(),a.game.ruler.state.active=!0,a.game.ruler.sendStateCmd()}}};a.current_mode=k,a.selection={active:!1,x:10,y:10,start_x:10,start_y:10,width:0,height:0},a.drag={start_x:0,start_y:0},(!c.id||c.id.length<=0)&&b.go("start"),d.get("/api/games/"+c.id).then(function(b){return j.then(function(){a.game=g(b.data)})},function(a){return b.go("start"),e.reject()}).then(function(){function b(b){var c=b.match(/[^\r\n]+/g);
a.create_model_preview.info=[];var d=0,e=0,f=0;_.each(c,function(b){if(!b.match(/^(System:|Faction:|Casters:|Points:|Tiers:)/)&&(b=b.replace(/^\s*/,""),0!==b.length)){b=b.replace(/^\*+ /,"");var c=1,g=b.match(/^(\d+) /);if(g&&(c=g[1]>>0,b=b.replace(/^\d+ /,"")),g=b.match(/\((\d+)\s.+?\)/i),g&&(c=g[1]>>0),g=b.match(/\(leader and (\d+) grunts?\)/i),g&&(c=(g[1]>>0)+1),b=b.replace(/\s*\(.+\)\s*$/,""),_.isArray(a.factions.fk_keys[b])&&a.factions.fk_keys[b].length>0)if(a.factions.fk_keys[b].length>1)_.each(a.factions.fk_keys[b],function(c){a.create_model_preview.info.push({info:c,offset_x:e+1.25*a.factions.fk_keys[b][0].r,offset_y:f}),e+=2.5*a.factions.fk_keys[b][0].r,e>360&&(e=0,f=55),d++});else{var h=Math.ceil(c/2),i=2.5*a.factions.fk_keys[b][0].r,j=0;_.times(c,function(g){var k=0,l=0;5>=c?(k=g*i+i/2,l=f):(k=d%h*i+i/2,l=f+(g>=h?i:0)),j=Math.max(j,k),a.create_model_preview.info.push({info:a.factions.fk_keys[b][0],offset_x:e+k,offset_y:l,show_leader:c>1&&0===g}),d++}),e+=j+i/2,e>360&&(e=0,f=55)}else a.fk_read_result.push('!!! unknown model "'+b+'"')}}),d>0&&(a.create_mode=!0)}var c=document.getElementById("canvas");a.show_ruler=a.game.ruler.state.active;var d={8:"Backspace",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",106:"Multiply",107:"Add",109:"Substract",110:"Point",111:"Divide",59:"SemiColon",61:"Equal",188:"Comma",189:"Dash",190:"Period",191:"ForwardSlash",219:"OpenBracket",220:"BackSlash",221:"CloseBracket",222:"SingleQuote"};a.onKeyDown=function(b){var c;if(b.keyCode>=48&&b.keyCode<=57||b.keyCode>=65&&b.keyCode<=90)c=String.fromCharCode(b.keyCode);else if(b.keyCode>=96&&b.keyCode<=105)c=String.fromCharCode(b.keyCode-48);else if(b.keyCode>=112&&b.keyCode<=120)c="F"+String.fromCharCode(b.keyCode-63);else if(b.keyCode>=121&&b.keyCode<=123)c="F1"+String.fromCharCode(b.keyCode-73);else{if(!_.has(d,b.keyCode))return;c=d[b.keyCode]}return b.shiftKey&&(c="Shift "+c),b.ctrlKey&&(c="Ctrl "+c),b.altKey&&(c="Alt "+c),"Escape"===c?(b.preventDefault(),void(a.current_mode=k)):_.has(a.current_mode,c)?(b.preventDefault(),void a.current_mode[c](b)):void 0},a.stopKeyPropagation=function(a){a.stopPropagation()},a.onModelMouseDown=function(b,d){var e=c.getBoundingClientRect(),f=(b.clientX-e.left)/a.game.board.zoom.factor*480/800,g=(b.clientY-e.top)/a.game.board.zoom.factor*480/800;a.drag.state="starting",a.drag.start_x=f,a.drag.start_y=g,a.drag.event="Model",a.drag.target=d,b.stopPropagation()},a.onTemplateMouseDown=function(b,d){var e=c.getBoundingClientRect(),f=(b.clientX-e.left)/a.game.board.zoom.factor*480/800,g=(b.clientY-e.top)/a.game.board.zoom.factor*480/800;a.drag.state="starting",a.drag.start_x=f,a.drag.start_y=g,a.drag.event="Template",a.drag.target=d,b.stopPropagation()},a.onModelClick=function(a){},a.onTemplateClick=function(a){},a.doSelectStart=function(b){var d=c.getBoundingClientRect(),e=(b.clientX-d.left)/a.game.board.zoom.factor*480/800,f=(b.clientY-d.top)/a.game.board.zoom.factor*480/800;a.drag.state="starting",a.drag.start_x=e,a.drag.start_y=f,a.drag.event="Board"},a.doSelectMove=function(b){var d=c.getBoundingClientRect(),e=(b.clientX-d.left)/a.game.board.zoom.factor*480/800,f=(b.clientY-d.top)/a.game.board.zoom.factor*480/800;if("draging"===a.drag.state||"starting"===a.drag.state){var g=e-a.drag.start_x,h=f-a.drag.start_y;return void("starting"===a.drag.state&&(Math.abs(g)>.1||Math.abs(h)>.1)?(a.drag.state="draging",_.has(a.current_mode,"DragStart")&&a.current_mode.DragStart(b,a.drag,g,h)):"draging"===a.drag.state&&_.has(a.current_mode,"Drag")&&a.current_mode.Drag(b,a.drag,e,f,g,h))}_.has(a.current_mode,"MouseMove")&&a.current_mode.MouseMove(b,e,f)},a.doSelectStop=function(b){var d=c.getBoundingClientRect(),e=(b.clientX-d.left)/a.game.board.zoom.factor*480/800,f=(b.clientY-d.top)/a.game.board.zoom.factor*480/800,g=a.drag.state;if(a.drag.state=null,"draging"===g){var h=e-a.drag.start_x,i=f-a.drag.start_y;_.has(a.current_mode,"DragEnd")&&a.current_mode.DragEnd(b,a.drag,e,f,h,i)}else _.has(a.current_mode,"Click")&&a.current_mode.Click(b,a.drag,e,f)},a.chat_msg="",a.doSendMessage=function(){if(!(0>=a.chat_msg.length)){var b=i("chat",a.chat_msg);a.game.newMessage(b),a.chat_msg=""}},a.onLayerChange=function(b){a.game.newCommand(h("setLayer",b))},a.doModelDamage=function(b,c,d){a.game.newCommand(h("onSelection","toggleDamage",c,d))},a.restore_selection={},a.isRestoreSelectionEmpty=function(){return 0===_.keys(a.restore_selection).length},a.doToggleRestoreSelection=function(b){a.restore_selection[b]?delete a.restore_selection[b]:a.restore_selection[b]=!0},a.doRestoreSelection=function(){a.game.newCommand(h("restoreFromDropBin",_.keys(a.restore_selection)))},a.doRestoreAll=function(){a.game.newCommand(h("restoreFromDropBin",_.map(a.game.drop_bin,function(a){return a.state.id})))},a.create_mode=!1,a.model={faction:null,type:null,unit:null,unit_entry:null,id:null,size:1,info:[]},a.create_model_preview={x:0,y:0,info:null},a.$watch("model",function(){a.create_mode=null},!0),a.doToggleCreateModel=function(){if(a.current_mode=a.current_mode===m?k:m,a.current_mode===m){a.create_model_preview.info=[];var b=Math.ceil(a.model.size/2),c=3*a.model.id.r;_.times(a.model.size,function(d){var e=0,f=0;a.model.size<=5?(e=d*c-(a.model.size-1)*c/2,f=0):(e=d%b*c-(b-1)*c/2,f=d>=b?c:0),a.create_model_preview.info.push({info:a.model.id,offset_x:e,offset_y:f})})}},a.modelShow=function(b){return a.game?_.filter(a.game.models,function(a){return a.state["show_"+b]}):[]},a.showCenteredAoE=function(){return a.game?_.filter(a.game.models,function(a){return a.state.show_aoe>0}):[]},a.fk_read_result=[],a.fk_read_string="",a.readFKFile=function(c){a.create_mode=!1,a.fk_read_result=[];var d=new f.FileReader;d.onload=function(c){a.fk_read_result.push("loaded file");var d=c.target.result;b(d),a.$apply()},d.onerror=function(){a.fk_read_result=["error reading file"],a.$apply()},d.onabort=function(){a.fk_read_result=["abort reading file"],a.$apply()},d.readAsText(c)},a.readFKString=function(){a.create_mode=!1,a.fk_read_result=[],b(a.fk_read_string)},a.doSetLabel=function(){a.game.newCommand(h("onSelection","setLabel",a.model_label)),a.model_label=""},a.doResetAllModelDamage=function(){a.game.newCommand(h("onSelection","resetAllDamage"))},a.create_template_mode=!1,a.mode_template_origin=!1,a.mode_template_target=!1,a.create_template_preview={type:null,size:0,origin:null,x:0,y:0,rot:0,locked:!1},a.doCreateTemplate=function(b,c){a.create_template_preview.type=b,a.create_template_preview.size=c,a.create_template_preview.x=240,a.create_template_preview.y=240,a.create_template_mode=!0},a.aoe_max_deviation=6,a.doAoEDeviation=function(){var b=a.game.templates.active,c=a.game.rollDeviation(a.aoe_max_deviation),d=60*(c.direction-1)+b.rot,e=b.x+c.distance*Math.sin(d*Math.PI/180),f=b.y-c.distance*Math.cos(d*Math.PI/180);a.game.newCommand(h("onActiveTemplate","set",e,f,d))},a.templateShowLocked=function(b){return a.game?_.filter(a.game.templates[b],function(a){return a.locked}):[]},a.templateShowUnlocked=function(b){return a.game?_.filter(a.game.templates[b],function(a){return!a.locked}):[]},a.hideLos=function(){a.game.los.state.active&&a.game.newCommand(h("onLos","setActive",!1))}})}]),_.mixin({deepExtend:function a(b,c){return _.each(c,function(c,d){!_.isObject(c)||_.isArray(c)||_.isFunction(c)||!_.isObject(b[d])||_.isArray(b[d])||_.isFunction(b[d])?b[d]=c:a(b[d],c)}),b}}),angular.module("jlogApp.services").factory("backup",["$window","$http","$q",function(a,b,c){return a.URL=a.URL||a.webkitURL,{read_result:null,save_url:null,save_name:"battle_list.txt",read:function(b,c,d){var e="function"==typeof c?c:function(a){},f="function"==typeof d?d:function(a){};this.read_result=null;var g=new a.FileReader;g.onload=function(a){var b;try{b=JSON.parse(a.target.result),e(b)}catch(c){f("invalid file")}},g.onerror=function(){f("error reading file")},g.onabort=function(){f("abort reading file")},g.readAsText(b)},generate:function(b){var c=this.save_url;this.save_url=null,null!==c&&a.URL.revokeObjectURL(c);var d=JSON.stringify(b),e=new a.Blob([d],{type:"text/plain"}),f=a.URL.createObjectURL(e),g=new Date;this.save_name="battle_list_"+g.getTime()+".txt",this.save_url=f},upload:function(a){var d=this;return d.upload.id=null,d.upload.status=null,d.upload.msg="Uploading...",b.post("/api/log",{battles:a},{timeout:2e4}).then(function(a){return d.upload.status=!0,d.upload.msg="data uploaded",d.upload.id=a.data.id,a.data},function(a){return d.upload.status=!1,d.upload.msg="upload failure ("+a.status+")",c.reject(a)})},download:function(){var a=this;return a.download.status=null,a.download.msg="Downloading...",b.get("/api/log/"+a.download.id,{timeout:2e4}).then(function(b){return a.download.status=!0,a.download.msg="data downloaded",b.data.battles},function(b){return a.download.status=!1,a.download.msg="download failure ("+b.status+")",c.reject(b)})},statusReset:function(){this.upload.id=null,this.upload.status=null,this.upload.msg=null,this.download.id=null,this.download.status=null,this.download.msg=null}}}]),angular.module("jlogApp.services").factory("battle",[function(){function a(a){if(!_.isString(a))return null;var b=a.charAt(a.length-1);return("0">b||b>"9")&&(a+="1"),a}function b(a){this.tags.push(a),this.tags.sort()}return function(c){var d=new Date;c=c||{};var e=_.deepExtend({date:{year:d.getFullYear(),month:d.getMonth()+1,day:d.getDate()},my_army:{caster:null,faction:null},opponent:{name:null,caster:null,faction:null},points:{my_army:{scenario:null,army:null,kill:null},opponent:{scenario:null,army:null,kill:null}},setup:{size:null,scenario:null,event:null,initiative:{started:null,won_roll:null}},score:null,comment:null,tags:[],addTag:b},c);return _.isObject(e.initiative)&&(_.deepExtend(e.setup.initiative,e.initiative),delete e.initiative),e.my_army.caster=a(e.my_army.caster),e.opponent.caster=a(e.opponent.caster),e}}]).service("battles",["storage","battle",function(a,b){var c={list:[]},d=function(){a.setItem(a.KEYS.BATTLES,JSON.stringify(c.list))},e=function(){return JSON.parse(a.getItem(a.KEYS.BATTLES))},f=function(){var b=a.getItem(a.KEYS.BATTLES);return"string"==typeof b&&b.length>0},g=function(){var a=0;for(a=0;a<c.list.length;a++)c.list[a].index=a};return c.update=function(){g(),d()},c.create=function(a){this.list=[],_.isArray(a)&&(this.list=_.map(a,b)),this.update()},c.init=function(){this.create(f()?e():[])},c.save=function(a,b){this.list.length>a?this.list[a]=b:this.list.push(b),this.update()},c.clear=function(a,b,c){_.each(this.list,function(d){0<=b.call(d).indexOf(a)&&c.call(d,a)}),this.update()},c.remove=function(a){a<this.list.length&&(this.list.splice(a,1),this.update())},c}]),angular.module("jlogApp.services").service("battles_display",["battles","battleFilter","orderByFilter",function(a,b,c){function d(){var a=this.sorted_list.slice(this.last_index,this.last_index+this.slice);this.display_list=this.display_list.concat(a),this.last_index+=this.slice,this.more=this.last_index<this.sorted_list.length}function e(a,d,e){this.sorted_list=b(this.list,a,d),this.sorted_list=c(this.sorted_list,e.types[e.type].key,e.reverse)}return _.extend(a,{sorted_list:[],display_list:[],slice:15,last_index:0,more:!1,reset:function(a,b,c){this.sorted_list=[],this.display_list=[],this.slice=15,this.last_index=0,this.more=!1,e.call(this,a,b,c),d.call(this)},showMore:function(){this.more&&d.call(this)}}),a}]),angular.module("jlogApp.services").service("events",["storage",function(a){var b={list:[]},c=function(){a.setItem(a.KEYS.EVENTS,JSON.stringify(b.list))},d=function(){return JSON.parse(a.getItem(a.KEYS.EVENTS))},e=function(){var b=a.getItem(a.KEYS.EVENTS);return"string"==typeof b&&b.length>0},f=function(a){if(b.list=[],_.isArray(a)){var c={};_.each(a,function(a){_.isObject(a.setup)&&_.isString(a.setup.event)&&(c[a.setup.event]=!0)}),b.list=_.keys(c),b.list.sort()}};return b.create=function(a){f(a),c()},b.init=function(a){e()?this.list=d().sort():this.create(a)},b.update=c,b.add=function(a){0<a.length&&(this.list.push(a),this.list.sort(),c())},b.remove=function(a){var b=this.list.indexOf(a);b>=0&&(this.list.splice(b,1),c())},b}]),angular.module("jlogApp.services").service("export_csv",["battle",function(a){function b(a,c,d){return _.isString(c)||(c=""),_.reduce(a,function(a,e,f){return"$"===f[0]||_.isFunction(e)||(d[f]={},a+=!_.isObject(e)||_.isArray(e)?c+f+",":b(e,c+f+".",d[f])),a},"")}function c(a,b){return _.reduce(b,function(b,d,e){return _.has(a,e)&&(_.isArray(a[e])?(_.each(a[e],function(a){b+=a+"::"}),a[e].length>0&&(b=b.slice(0,b.length-2)),b+=","):b+=_.isObject(a[e])?c(a[e],d):a[e]+","),b},"")}return{generate:function(d){var e="",f={};return e+=b(a({}),"",f)+"\r\n",_.reduce(d,function(a,b){return a+=c(b,f)+"\r\n"},e)}}}]).service("export_bb",["battle",function(a){function b(a,c,d){return _.isString(c)||(c=""),_.reduce(a,function(a,e,f){return"$"===f[0]||_.isFunction(e)||(d[f]={},a+=!_.isObject(e)||_.isArray(e)?"[th]"+c+f+"[/th]":b(e,c+f+".",d[f])),a},"")}function c(a,b){return _.reduce(b,function(b,d,e){return a.hasOwnProperty(e)&&(_.isArray(a[e])?(b+="[td]",_.each(a[e],function(a){b+=a+","}),a[e].length>0&&(b=b.slice(0,b.length-1)),b+="[/td]"):b+=_.isObject(a[e])?c(a[e],d):"[td]"+a[e]+"[/td]"),b},"")}return{generate:function(d){var e="[table]\r\n",f={};return e+="[tr]"+b(a({}),"",f)+"[/tr]\r\n",e+=_.reduce(d,function(a,b){return a+="[tr]"+c(b,f)+"[/tr]\r\n"},""),e+="[/table]\r\n"}}}]).service("export",["$window","export_csv","export_bb",function(a,b,c){function d(b,c){var d=this[b+"_url"];this[b+"_url"]=null,null!==d&&a.URL.revokeObjectURL(d);var e=c(),f=new a.Blob([e],{type:"text/plain"}),g=a.URL.createObjectURL(f);this[b+"_url"]=g}return{name:null,bb_url:null,csv_url:null,json_url:null,generate:function(a){var e=new Date;this.name="battle_list_"+e.getTime(),d.call(this,"bb",function(){return c.generate(a)}),d.call(this,"csv",function(){return b.generate(a)}),d.call(this,"json",function(){return JSON.stringify(a)})}}}]),angular.module("jlogApp.services").value("default_factions",{cephalyx:{name:"Cephalyx",casters:{thexus1:{name:"Exulon Thexus"}},icon:"mercs_50.png"},cygnar:{name:"Cygnar",casters:{blaize:{name:"Constance Blaize,  Knight of the Prophet"},siege:{name:"Major Markus 'Siege' Brisbane"},caine1:{name:"Lieutenant Allister Caine"},caine2:{name:"Captain Allister Caine"},darius:{name:"Captain E. Dominic Darius"},haley1:{name:"Captain Victoria Haley"},haley2:{name:"Major Victoria Haley"},kraye:{name:"Captain Jeremiah Kraye"},nemo1:{name:"Commander Adept Sebastian Nemo"},nemo2:{name:"General Adept Sebastian Nemo"},nemo3:{name:"Artificer General Nemo"},sloan:{name:"Captain Kara Sloan"},stryker1:{name:"Commander Coleman Stryker"},stryker2:{name:"Lord Commander Stryker"},stryker3:{name:"Lord General Coleman Stryker"},sturgis1:{name:"Commander Dalin Sturgis"}},icon:"cygnar_50.png"},menoth:{name:"The Protectorate of Menoth",casters:{kreoss1:{name:"High Exemplar Kreoss"},kreoss2:{name:"Grand Exemplar Kreoss"},kreoss3:{name:"Intercessor Kreoss"},reclaimer:{name:"High Reclaimer"},testament:{name:"Testament of Menoth"},severius1:{name:"Grand Scrutator Severius"},severius2:{name:"Hierarch Severius"},feora1:{name:"Feora,  Priestess of the Flame"},feora2:{name:"Feora,  Protector of the Flame"},amon:{name:"High Allegiant Amon Ad'Raza"},harbinger:{name:"Harbinger of Menoth"},reznik1:{name:"High Executioner Servath Reznik"},reznik2:{name:"Servath Reznik, Wrath of Ages"},vindictus:{name:"Vice Scrutator Vindictus"},thyra:{name:"Thyra,  Flame of Sorrow"}},icon:"menoth_50.png"},khador:{name:"Khador",casters:{butcher1:{name:"Orsus Zoktavir,  Butcher of Khardov"},butcher2:{name:"Kommander Orsus Zoktavir"},sorscha1:{name:"Kommander Sorscha Kratikoff"},sorscha2:{name:"Forward Kommander Sorscha Kratikoff"},vlad1:{name:"Vladimir Tzepesci,  The Dark Prince"},vlad2:{name:"Vladimir Tzepesci,  The Dark Champion"},vlad3:{name:"Vladimir Tzepesci,  Great Prince of Umbrey"},irusk1:{name:"Kommandant Irusk"},irusk2:{name:"Supreme Kommandant Irusk"},zerkova:{name:"Koldun Kommander Aleksandra Zerkova"},karchev:{name:"Karchev the Terrible"},"the old witch":{name:"Zevanna Agha,  Old Witch of Khador"},strakhov:{name:"Kommander Strakhov"},harkevich:{name:"Kommander Harkevich,  The Iron Wolf"},butcher3:{name:"Kommander Zoktavir,  The Butcher Unleashed"}},icon:"khador_50.png"},cryx:{name:"Cryx",casters:{asphyxious1:{name:"Iron Lich Asphyxious"},asphyxious2:{name:"Lich Lord Asphyxious"},asphyxious3:{name:"Asphyxious the Hellbringer"},deneghra1:{name:"War Witch Deneghra"},deneghra2:{name:"Wraith Witch Deneghra"},goreshade1:{name:"Goreshade the Bastard"},goreshade2:{name:"Goreshade the Cursed"},goreshade3:{name:"Goreshade, Lord of Ruin"},mortenebra:{name:"Master Necrotech Mortenebra"},scaverous:{name:"Lord Exhumator Scaverous"},skarre1:{name:"Skarre,  the Pirate Queen"},skarre2:{name:"Skarre,  Queen of the Broken Coast"},terminus:{name:"Lich Lord Terminus"},venethrax:{name:"Lich Lord Venethrax"},"witch coven":{name:"The Witch Coven of Garlghast"},sturgis2:{name:"Sturgis the Corrupted"}},icon:"cryx_50.png"},scyrah:{name:"Retribution of Scyrah",casters:{garryth:{name:"Garryth,  Blade of Retribution"},kaelyssa:{name:"Kaelyssa,  Night's Whisper"},ossyan:{name:"Lord Arcanist Ossyan"},rahn:{name:"Adeptis Rahn"},ravyn:{name:"Ravyn,  Eternal Light"},vyros1:{name:"Dawnlord Vyros"},vyros2:{name:"Vyros,  Incissar of the Dawnguard"},issyria:{name:"Issyria,  Sibyl of Dawn"}},icon:"scyrah_50.png"},highborn:{name:"Highborn Covenant",casters:{ashlynn:{name:"Ashlynn D'Elyse"},bartolo:{name:"Captain Bartolo Montador"},damiano:{name:"Captain Damiano"},blaize:{name:"Constance Blaize,  Knight of the Prophet"},macbain:{name:"Drake MacBain"},madhammer:{name:"Durgen Madhammer"},fiona:{name:"Fiona the Black"},ossrum:{name:"General Ossrum"},gorten:{name:"Gorten Grundback"}},icon:"mercs_50.png"},seaforge:{name:"Searforge Commission",casters:{madhammer:{name:"Durgen Madhammer"},ossrum:{name:"General Ossrum"},gorten:{name:"Gorten Grundback"}},icon:"mercs_50.png"},talion:{name:"Talion Charter",casters:{bartolo:{name:"Captain Bartolo Montador"},fiona:{name:"Fiona the Black"},shae:{name:"Captain Phinneus Shae"}},icon:"mercs_50.png"},fourstar:{name:"Four Star Syndicate",casters:{bartolo:{name:"Captain Bartolo Montador"},damiano:{name:"Captain Damiano"},macbain:{name:"Drake MacBain"},madhammer:{name:"Durgen Madhammer"},ossrum:{name:"General Ossrum"},gorten:{name:"Gorten Grundback"},fiona:{name:"Fiona the Black"},magnus1:{name:"Magnus the Traitor"},magnus2:{name:"Magnus the Warlord"}},icon:"mercs_50.png"},troll:{name:"Trollbloods",casters:{borka1:{name:"Borka Kegslayer"},borka2:{name:"Borka, Vengeance of the Rimeshaws"},calandra:{name:"Calandra Truthsayer,  Oracle of the Glimmerwood"},grim1:{name:"Grim Angus"},grissel1:{name:"Grissel Bloodsong"},grissel2:{name:"Grissel Bloodsong,  Marshal of the Kriels"},gunnbjorn:{name:"Captain Gunnbjorn"},doomshaper1:{name:"Hoarluk Doomshaper,  Shaman of the Gnarls"},doomshaper2:{name:"Hoarluk Doomshaper,  Rage of Dhunia"},jarl:{name:"Jarl Skuld,  Devil of the Thornwood"},madrak1:{name:"Chief Madrak Ironhide"},madrak2:{name:"Madrak Ironhide,  World Ender"},grim2:{name:"Hunters Grim"}},icon:"troll_50.png"},circle:{name:"Circle Orboros",casters:{baldur1:{name:"Baldur the Stonecleaver"},baldur2:{name:"Baldur the Stonesoul"},bradigus1:{name:"Haribo Dragibus"},cassius:{name:"Cassius the Oathkeeper & Wurmwood,  Tree of Fate"},grayle:{name:"Grayle the Farstrider"},kaya1:{name:"Kaya the Wildborne"},kaya2:{name:"Kaya the Moonhunter and Laris"},kromac:{name:"Kromac the Ravenous"},krueger1:{name:"Krueger the Stormwrath"},krueger2:{name:"Krueger the Stormlord"},mohsar:{name:"Mohsar the Desertwalker"},morvahna1:{name:"Morvahna the Autumnblade"},morvahna2:{name:"Morvahna the Dawnshadow"}},icon:"circle_50.png"},skorne:{name:"Skorne",casters:{hexeris1:{name:"Lord Tyrant Hexeris"},hexeris2:{name:"Lord Arbiter Hexeris"},makeda1:{name:"Archdomina Makeda"},makeda2:{name:"Supreme Archdomina Makeda"},mordikaar:{name:"Void Seer Mordikaar"},morghoul1:{name:"Master Tormentor Morghoul"},morghoul2:{name:"Lord Assassin Morghoul"},naaresh:{name:"Master Ascetic Naaresh"},rasheth:{name:"Dominar Rasheth"},xerxis1:{name:"Tyrant Xerxis"},xerxis2:{name:"Xerxis Fury of Halaak"},zaal:{name:"Supreme Aptimus Zaal"},makeda3:{name:"Makeda & the Exalted Court"}},icon:"skorne_50.png"},loe:{name:"Legion of Everblight",casters:{absylonia1:{name:"Absylonia,  Terror of Everblight"},absylonia2:{name:"Absylonia,  Daughter of Everblight"},bethayne:{name:"Bethayne,  Voice of Everblight"},kallus:{name:"Kallus,  Wrath of Everblight"},lylyth1:{name:"Lylyth,  Herald of Everblight"},lylyth2:{name:"Lylyth,  Shadow of Everblight"},rhyas:{name:"Rhyas,  Sigil of Everblight"},saeryn:{name:"Saeryn,  Omen of Everblight"},thagrosh1:{name:"Thagrosh,  Prophet of Everblight"},thagrosh2:{name:"Thagrosh,  Messiah of Everblight"},vayl1:{name:"Vayl,  Disciple of Everblight"},vayl2:{name:"Vayl,  Consul of Everblight"},lylyth3:{name:"Lylyth,  Reckoning of Everblight"}},icon:"loe_50.png"},blindwater:{name:"Blindwater Congregation",casters:{barnabas:{name:"Bloody Barnabas"},calaban:{name:"Calaban the Gravewalker"},maelok:{name:"Maelok the Dreadbound"},jaga1:{name:"Jaga-Jaga, the Death Charmer"},rask:{name:"Rask"}},icon:"minions_50.png"},thornfall:{name:"Thornfall Alliance",casters:{carver:{name:"Lord Carver,  BMMD,  Esq III"},helga:{name:"Helga, the Conqueror"},arkadius:{name:"Dr. Arkadius"},"sturm & drang":{name:"Sturm & Drang"},midas:{name:"Midas"}},icon:"minions_50.png"},mercs:{name:"Mercenary Theme Forces",casters:{ashlynn:{name:"Ashlynn D'Elyse"},bartolo:{name:"Captain Bartolo Montador"},damiano:{name:"Captain Damiano"},shae:{name:"Captain Phinneus Shae"},macbain:{name:"Drake MacBain"},madhammer:{name:"Durgen Madhammer"},ossrum:{name:"General Ossrum"},gorten:{name:"Gorten Grundback"},fiona:{name:"Fiona the Black"},magnus1:{name:"Magnus the Traitor"},magnus2:{name:"Magnus the Warlord"},thexus1:{name:"Exulon Thexus"}},icon:"mercs_50.png"},minions:{name:"Minion Theme Forces",casters:{barnabas:{name:"Bloody Barnabas"},calaban:{name:"Calaban the Gravewalker"},arkadius:{name:"Dr. Arkadius"},carver:{name:"Lord Carver,  BMMD,  Esq III"},helga:{name:"Helga, the Conqueror"},jaga1:{name:"Jaga-Jaga, the Death Charmer"},maelok:{name:"Maelok the Dreadbound"},"sturm & drang":{name:"Sturm & Drang"},rask:{name:"Rask"},midas:{name:"Midas"}},icon:"minions_50.png"},cyriss:{name:"Convergence of Cyriss",casters:{aurora:{name:"Aurora,  Numen of Aerogenesis"},axis:{name:"Axis,  the Harmonic Enforcer"},directrix:{name:"Iron Mother Directrix & Exponent Servitors"},lucant:{name:"Father Lucant,  Divinity Architect"},syntherion:{name:"Forge Master Syntherion"}},icon:"cyriss_50.png"}}).service("factions",["default_factions",function(a){function b(a){if(!angular.isString(a))return null;var b=a.charAt(a.length-1);return("0">b||b>"9")&&(a+="1"),a}var c={};return _.each(a,function(a,d){c[d]={name:a.name,icon:a.icon,casters:{}},_.each(a.casters,function(a,e){var f=b(e);c[d].casters[f]=a})}),c}]),angular.module("jlogApp.services").factory("filterMatchSimple",[function(){return function(a,b){return _.extend({active:!1,is:"true",value:[],match:function(a){var c=0===this.value.length||0<=this.value.indexOf(b(a));return!this.active||("true"===this.is?c:!c)}},a)}}]).factory("filterMatchComp",[function(){return function(a,b){return 0===a?0===b:1===a?0!==b:2===a?-1===b:3===a?1!==b:4===a?1===b:5===a?-1!==b:!1}}]).factory("filterMatchDate",["filterMatchComp",function(a){var b=function(a,b){return a.year>b.year?1:a.year<b.year?-1:a.month>b.month?1:a.month<b.month?-1:a.day>b.day?1:a.day<b.day?-1:0};return function(c){var d=new Date;return _.extend({active:!1,is:"0",year:d.getFullYear(),month:d.getMonth()+1,day:d.getDate(),match:function(c){var d=b(this,c.date),e=parseInt(this.is,10),f=a(e,d);return!this.active||f}},c)}}]).factory("filterMatchSize",["filterMatchComp",function(a){var b=function(a,b){return a>b?1:b>a?-1:0};return function(c){return _.extend({active:!1,is:"0",value:50,match:function(c){var d=b(this.value,c.setup.size),e=parseInt(this.is,10),f=a(e,d);return!this.active||f}},c)}}]).factory("filterMatchCaster",[function(){return function(a,b){return _.extend({active:!1,is:"true",faction:null,caster:[],match:function(a){var c=this.faction===b(a).faction&&(0===this.caster.length||0<=this.caster.indexOf(b(a).caster));return!this.active||("true"===this.is?c:!c)}},a)}}]).factory("filterMatchInitiative",[function(){return function(a){return _.extend({active:!1,is:"true",won_roll:"",started:"",match:function(a){var b=!(0!==this.won_roll.length&&this.won_roll!==a.setup.initiative.won_roll||0!==this.started.length&&this.started!==a.setup.initiative.started);return!this.active||("true"===this.is?b:!b)}},a)}}]).factory("filterMatchTags",[function(){return function(a){return _.extend({active:!1,is:"any",value:[],match:function(a){if(!this.active||0===this.value.length)return!0;if(0===a.tags.length)return"none"===this.is||"not_all"===this.is;var b,c=!0,d=!1;switch(_.each(this.value,function(e){b=0<=a.tags.indexOf(e),c=c&&b,d=d||b}),this.is){case"any":return d;case"all":return c;case"not_all":return!c;case"none":return!d;default:return!1}}},a)}}]).factory("filter",["storage","filterMatchSimple","filterMatchDate","filterMatchSize","filterMatchCaster","filterMatchInitiative","filterMatchTags",function(a,b,c,d,e,f,g){var h=function(b){a.setItem(a.KEYS.FILTER,JSON.stringify(b))},i=function(){return JSON.parse(a.getItem(a.KEYS.FILTER))},j=function(){var b=a.getItem(a.KEYS.FILTER);return"string"==typeof b&&0<b.length},k=function(a){return{date:c(_.isObject(a.date)?a.date:{}),my_army:e(_.isObject(a.my_army)?a.my_army:{},function(a){return a.my_army}),opp_name:b(_.isObject(a.opp_name)?a.opp_name:{},function(a){return a.opponent.name}),opp_caster:e(_.isObject(a.opp_caster)?a.opp_caster:{},function(a){return a.opponent}),result:b(_.isObject(a.result)?a.result:{},function(a){return a.score}),scenario:b(_.isObject(a.scenario)?a.scenario:{},function(a){return a.setup.scenario}),initiative:f(_.isObject(a.initiative)?a.initiative:{}),size:d(_.isObject(a.size)?a.size:{}),event:b(_.isObject(a.event)?a.event:{},function(a){return a.setup.event}),tags:g(_.isObject(a.tags)?a.tags:{})}},l={};return{list:null,init:function(){if(j()){var a=i();this.list=k(a)}else this.list=k({}),h(this.list);this.clearCache()},update:function(){h(this.list)},match:function(a,b){return l.hasOwnProperty(a.index)||(l[a.index]=_.reduce(this.list,function(b,c){return b&&c.match(a)},!0)),b?!l[a.index]:l[a.index]},clearCache:function(a){void 0===a?l={}:delete l[a]}}}]),angular.module("jlogApp.services").service("opponents",["storage",function(a){var b={list:[]},c=function(){a.setItem(a.KEYS.OPPONENTS,JSON.stringify(b.list))},d=function(){return JSON.parse(a.getItem(a.KEYS.OPPONENTS))},e=function(){var b=a.getItem(a.KEYS.OPPONENTS);return"string"==typeof b&&b.length>0},f=function(a){if(b.list=[],_.isArray(a)){var c={};_.each(a,function(a){_.isObject(a.opponent)&&_.isString(a.opponent.name)&&(c[a.opponent.name]=!0)}),b.list=_.keys(c),b.list.sort()}};return b.create=function(a){f(a),c()},b.init=function(a){e()?this.list=d().sort():this.create(a)},b.update=c,b.add=function(a){0<a.length&&(this.list.push(a),this.list.sort(),c())},b.remove=function(a){var b=this.list.indexOf(a);b>=0&&(this.list.splice(b,1),c())},b}]),angular.module("jlogApp.services").value("default_scenarios",{sr14des:{name:"SR14 Destruction"},sr14sad:{name:"SR14 Supply & Demand"},sr14bop:{name:"SR14 Balance of Power"},sr14poe:{name:"SR14 Process of Elimination"},sr14cq:{name:"SR14 Close Quarters"},sr14tf:{name:"SR14 Two Fronts"},sr14inco:{name:"SR14 Incoming"},sr14rp:{name:"SR14 Rally Point"},sr14incu:{name:"SR14 Incursion"},sr14out:{name:"SR14 Outflank"},sr14itb:{name:"SR14 Into the Breach"},sr14fs:{name:"SR14 Fire Support"},sr13des:{name:"SR13 Destruction"},sr13sad:{name:"SR13 Supply & Demand"},sr13cq:{name:"SR13 Close Quarters"},sr13ar:{name:"SR13 Ammunition Run"},sr13incu:{name:"SR13 Incursion"},sr13cr:{name:"SR13 Chemical Reaction"},sr13out:{name:"SR13 Outflank"},sr13inco:{name:"SR13 Incoming"},sr13itb:{name:"SR13 Into the Breach"},sr13rp:{name:"SR13 Rally Point"},sr13poe:{name:"SR13 Process of elimination"},sr13fs:{name:"SR13 Fire Support"}}).service("scenarios",["storage","default_scenarios",function(a,b){var c={list:angular.copy(b)},d=function(){a.setItem(a.KEYS.SCENARIOS,JSON.stringify(c.list))},e=function(){return JSON.parse(a.getItem(a.KEYS.SCENARIOS))},f=function(){var b=a.getItem(a.KEYS.SCENARIOS);return"string"==typeof b&&b.length>0},g=function(a){if(c.list=angular.copy(b),_.isArray(a)){var d={};_.each(a,function(a){_.isObject(a.setup)&&_.isString(a.setup.scenario)&&(d[a.setup.scenario]=!0)}),_.each(d,function(a,b){void 0===c.list[b]&&(c.list[b]={name:b})})}};return c.create=function(a){g(a),d()},c.init=function(a){f()?this.list=e():this.create(a)},c.update=d,c.add=function(a){var b="";return 0<a.length&&(b=a.toLowerCase(),this.list[b]={name:a},d()),b},c.remove=function(a){this.list.hasOwnProperty(a)&&(delete this.list[a],d())},c}]),angular.module("jlogApp.services").value("scores",{va:{result:"victory",type:"assassination"},vc:{result:"victory",type:"clock"},vs:{result:"victory",type:"scenario"},vt:{result:"victory",type:"tiebreaker"},dd:{result:"draw",type:"dice down"},da:{result:"defeat",type:"assassination"},dc:{result:"defeat",type:"clock"},ds:{result:"defeat",type:"scenario"},dt:{result:"defeat",type:"tiebreaker"}}),angular.module("jlogApp.services").factory("selection",[function(){var a=function(a){var b=!1;return"string"==typeof this.my_army.faction&&0<this.my_army.faction.length&&(b=!0,_.each(this.battles,function(b){a[b].my_army.faction=this.my_army.faction,a[b].my_army.caster=""})),"string"==typeof this.my_army.caster&&0<this.my_army.caster.length&&(b=!0,_.each(this.battles,function(b){a[b].my_army.caster=this.my_army.caster})),b},b=function(a){var b,c=!1;if("string"==typeof this.opponent.name&&0<this.opponent.name.length)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].opponent.name=this.opponent.name;if("string"==typeof this.opponent.faction&&0<this.opponent.faction.length)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].opponent.faction=this.opponent.faction,a[this.battles[b]].opponent.caster="";if("string"==typeof this.opponent.caster&&0<this.opponent.caster.length)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].opponent.caster=this.opponent.caster;return c},c=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].points&&(a[this.battles[b]].points={my_army:{scenario:null,army:null},opponents:{scenario:null,army:null}}),void 0===a[this.battles[b]].points.my_army&&(a[this.battles[b]].points.my_army={scenario:null,army:null}),void 0===a[this.battles[b]].points.opponent&&(a[this.battles[b]].points.opponent={scenario:null,army:null});if("number"==typeof this.points.my_army.scenario)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].points.my_army.scenario=this.points.my_army.scenario;if("number"==typeof this.points.my_army.army)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].points.my_army.army=this.points.my_army.army;if("number"==typeof this.points.opponent.scenario)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].points.opponent.scenario=this.points.opponent.scenario;if("number"==typeof this.points.opponent.army)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].points.opponent.army=this.points.opponent.army;return c},d=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].date&&(a[this.battles[b]].date={year:2e3,month:1,day:1});if("number"==typeof this.date.year)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].date.year=this.date.year;if("number"==typeof this.date.month)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].date.month=this.date.month;if("number"==typeof this.date.day)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].date.day=this.date.day;
return c},e=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].setup&&(a[this.battles[b]].setup={scenario:null,event:null,size:null,initiative:{won_roll:null,started:null}});if("string"==typeof this.setup.scenario)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].setup.scenario=this.setup.scenario;return c},f=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].setup&&(a[this.battles[b]].setup={scenario:null,event:null,size:null,initiative:{won_roll:null,started:null}});if("number"==typeof this.setup.size)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].setup.size=this.setup.size;return c},g=function(a){var b,c=!1;for(b=0;b<this.battles.length;b++)void 0===a[this.battles[b]].setup&&(a[this.battles[b]].setup={scenario:null,event:null,size:null,initiative:{won_roll:null,started:null}});if("string"==typeof this.setup.event)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].setup.event=this.setup.event;return c},h=function(a){var b,c=!1;if("string"==typeof this.score)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].score=this.score;return c},i=function(a){var b,c=!1;if(0<this.tags.length)for(c=!0,b=0;b<this.battles.length;b++)a[this.battles[b]].tags=this.tags.slice(0);return c},j=function(a){var b,c=!1;if(0<this.tags.length)for(c=!0,b=0;b<this.battles.length;b++){var d;for(d=0;d<this.tags.length;d++)void 0===a[this.battles[b]].tags&&(a[this.battles[b]].tags=[]),0>a[this.battles[b]].tags.indexOf(this.tags[d])&&a[this.battles[b]].tags.push(this.tags[d])}return c},k=function(a){var b;for(b=0;b<this.battles.length;b++)this.my_army.faction=null,this.my_army.caster=null,a[this.battles[b]].my_army.faction=null,a[this.battles[b]].my_army.caster=null},l=function(a){var b;for(b=0;b<this.battles.length;b++)this.opponent.name=null,this.opponent.faction=null,this.opponent.caster=null,a[this.battles[b]].opponent.name=null,a[this.battles[b]].opponent.faction=null,a[this.battles[b]].opponent.caster=null},m=function(a){var b;for(b=0;b<this.battles.length;b++)this.points={my_army:{scenario:null,army:null},opponent:{scenario:null,army:null}},a[this.battles[b]].points={my_army:{scenario:null,army:null},opponent:{scenario:null,army:null}}},n=function(a){var b;for(b=0;b<this.battles.length;b++)this.date={year:null,month:null,day:null},a[this.battles[b]].date={year:2e3,month:1,day:1}},o=function(a){var b;for(b=0;b<this.battles.length;b++)this.setup.scenario=null,a[this.battles[b]].setup.scenario=null},p=function(a){var b;for(b=0;b<this.battles.length;b++)this.setup.size=null,a[this.battles[b]].setup.size=null},q=function(a){var b;for(b=0;b<this.battles.length;b++)this.setup.event=null,a[this.battles[b]].setup.event=null},r=function(a){var b;for(b=0;b<this.battles.length;b++)this.score=null,a[this.battles[b]].score=null},s=function(a){var b;for(b=0;b<this.battles.length;b++)this.tags=[],a[this.battles[b]].tags=[]},t=function(a){var b;for(b=0;b<this.battles.length;b++){var c;for(c=0;c<this.tags.length;c++){var d=a[this.battles[b]].tags.indexOf(this.tags[c]);d>=0&&a[this.battles[b]].tags.splice(d,1)}}};return{full:!1,toggleFull:function(a){var b;for(b=0;b<a.length;b++)a[b].selected=this.full},battles:[],my_army:{},opponent:{},setup:{},tags:[],points:{my_army:{scenario:null,army:null},opponent:{scenario:null,army:null}},reset:function(a){this.full=!1,this.battles=[],this.my_army={},this.opponent={},this.setup={},this.tags=[],this.points={my_army:{scenario:null,army:null},opponent:{scenario:null,army:null}};var b;for(b=0;b<a.length;b++)a[b].selected=!1},remove:function(a){var b;for(this.battles.sort(),b=0;b<this.battles.length;b++)a.splice(this.battles[this.battles.length-b-1],1);var c=0<this.battles.length;return this.battles=[],c},update:function(a){this.battles=a.map(function(a){return a.index})},set:function(k,l){if(0===this.battles.length)return!1;var m=!1;switch(k){case"my_army":m=a.call(this,l);break;case"opponent":m=b.call(this,l);break;case"points":m=c.call(this,l);break;case"date":m=d.call(this,l);break;case"scenario":m=e.call(this,l);break;case"size":m=f.call(this,l);break;case"event":m=g.call(this,l);break;case"score":m=h.call(this,l);break;case"tags":m=i.call(this,l);break;case"addTags":m=j.call(this,l)}return m},unset:function(a,b){if(0===this.battles.length)return!1;var c=!1;switch(a){case"my_army":c=!0,k.call(this,b);break;case"opponent":c=!0,l.call(this,b);break;case"points":c=!0,m.call(this,b);break;case"date":c=!0,n.call(this,b);break;case"scenario":c=!0,o.call(this,b);break;case"size":c=!0,p.call(this,b);break;case"event":c=!0,q.call(this,b);break;case"score":c=!0,r.call(this,b);break;case"tags":c=!0,s.call(this,b);break;case"addTags":c=!0,t.call(this,b)}return c}}}]),angular.module("jlogApp.services").value("sort_types",{date:{name:"Date",key:["date.year","date.month","date.day","index"]},my_caster:{name:"My caster",key:["my_army.faction","my_army.caster","index"]},opponent:{name:"Opponent",key:["opponent.name","index"]},opp_caster:{name:"Opp. caster",key:["opponent.faction","opponent.caster","index"]},scenario:{name:"Scenario",key:["setup.scenario","index"]},size:{name:"Size",key:["setup.size","index"]},event:{name:"Event",key:["setup.event","index"]},result:{name:"Result",key:["score","index"]}}).factory("battle_sort",["sort_types",function(a){return{types:a,type:"date",reverse:!0,sortBy:function(a){this.types.hasOwnProperty(a)&&(this.type===a?this.reverse=!this.reverse:(this.type=a,this.reverse=!1))}}}]),angular.module("jlogApp.services").service("statEntryMyCaster",[function(){var a=function(){var a={};return a.addBattle=function(b){var c=b.my_army.faction+"|"+b.my_army.caster;a[c]=a[c]||0,a[c]++},a};return a}]).service("statEntryOppName",[function(){var a=function(){var a={};return a.addBattle=function(b){var c=b.opponent.name;a[c]=a[c]||0,a[c]++},a};return a}]).service("statEntryOppCaster",[function(){var a=function(){var a={};return a.addBattle=function(b){var c=b.opponent.faction;a[c]=a[c]||0,a[c]++},a};return a}]).service("statEntryEvent",[function(){var a=function(){var a={};return a.addBattle=function(b){var c=b.setup.event;a[c]=a[c]||0,a[c]++},a};return a}]).service("statEntryEvent",[function(){var a=function(){var a={};return a.addBattle=function(b){var c=b.setup.event;a[c]=a[c]||0,a[c]++},a};return a}]).service("statEntryScenario",[function(){var a=function(){var a={};return a.addBattle=function(b){var c=b.setup.scenario;a[c]=a[c]||0,a[c]++},a};return a}]).service("statEntrySize",[function(){var a=function(){var a={};return a.addBattle=function(b){var c=b.setup.size;a[c]=a[c]||0,a[c]++},a};return a}]).service("statEntryInit",[function(){var a=function(){var a={rw:0,rl:0,pf:0,ps:0};return a.addBattle=function(b){"true"===b.setup.initiative.won_roll&&a.rw++,"false"===b.setup.initiative.won_roll&&a.rl++,"true"===b.setup.initiative.started&&a.pf++,"false"===b.setup.initiative.started&&a.ps++},a};return a.legends=function(){return{rw:"Won Roll",rl:"Lost Roll",pf:"First Player",ps:"Second Player"}},a.colors=function(){return{rw:"#0C0",rl:"#C00",pf:"#06C",ps:"#048"}},a}]).service("statEntryResult",[function(){var a=function(){var a={va:0,vc:0,vs:0,vt:0,dd:0,da:0,dc:0,ds:0,dt:0};return a.addBattle=function(b){a[b.score]++},a};return a.legends=function(){return{va:"Assassination Victory",vc:"Clock Victory",vs:"Scenario Victory",vt:"Tiebreakers Victory",dd:"Dice Down Draw",da:"Assassination Defeat",dc:"Clock Defeat",ds:"Scenario Defeat",dt:"Tiebreakers Defeat"}},a.colors=function(){return{va:"#0C0",vc:"#0A0",vs:"#080",vt:"#060",dd:"#CC0",da:"#C00",dc:"#A00",ds:"#800",dt:"#600"}},a}]).service("statEntryPointScenario",[function(){var a=function(){var a={my_army:0,opponent:0};return a.addBattle=function(b){_.isNumber(b.points.my_army.scenario)&&_.isNumber(b.points.opponent.scenario)&&(a.my_army+=b.points.my_army.scenario,a.opponent+=b.points.opponent.scenario)},a};return a}]).service("statEntryPointArmy",[function(){var a=function(){var a={my_army:0,opponent:0};return a.addBattle=function(b){_.isNumber(b.points.my_army.army)&&_.isNumber(b.points.opponent.army)&&(a.my_army+=b.points.my_army.army,a.opponent+=b.points.opponent.army)},a};return a}]).service("statEntryPointKill",[function(){var a=function(){var a={my_army:0,opponent:0};return a.addBattle=function(b){_.isNumber(b.points.my_army.kill)&&_.isNumber(b.points.opponent.kill)&&(a.my_army+=b.points.my_army.kill,a.opponent+=b.points.opponent.kill)},a};return a}]).service("statEntryTag",[function(){var a=function(){var a={};return a.addBattle=function(b){_.each(b.tags,function(b){a[b]=a[b]||0,a[b]++})},a};return a}]),angular.module("jlogApp.services").service("statSelectorMyCaster",[function(){return function(a,b){var c={};return _.each(a,function(a){var d=a.my_army.faction,e=a.my_army.caster;void 0===c[d]&&(c[d]={all:b(),casters:{}}),void 0===c[d].casters[e]&&(c[d].casters[e]=b()),c[d].all.addBattle(a),c[d].casters[e].addBattle(a)}),c}}]).service("statSelectorOppName",[function(){return function(a,b){var c={};return _.each(a,function(a){var d=a.opponent.name;void 0===c[d]&&(c[d]=b()),c[d].addBattle(a)}),c}}]).service("statSelectorOppCaster",[function(){return function(a,b){var c={};return _.each(a,function(a){var d=a.opponent.faction,e=a.opponent.caster;void 0===c[d]&&(c[d]={all:b(),casters:{}}),void 0===c[d].casters[e]&&(c[d].casters[e]=b()),c[d].all.addBattle(a),c[d].casters[e].addBattle(a)}),c}}]).service("statSelectorEvent",[function(){return function(a,b){var c={};return _.each(a,function(a){var d=a.setup.event;void 0===c[d]&&(c[d]=b()),c[d].addBattle(a)}),c}}]).service("statSelectorScenario",[function(){return function(a,b){var c={};return _.each(a,function(a){var d=a.setup.scenario;void 0===c[d]&&(c[d]=b()),c[d].addBattle(a)}),c}}]).service("statSelectorSize",[function(){return function(a,b){var c={};return _.each(a,function(a){var d=a.setup.size+"pts";void 0===c[d]&&(c[d]=b()),c[d].addBattle(a)}),c}}]).service("statSelectorInit",[function(){return function(a,b){var c={rw:b(),rl:b(),pf:b(),ps:b()};return _.each(a,function(a){"true"===a.setup.initiative.won_roll&&c.rw.addBattle(a),"false"===a.setup.initiative.won_roll&&c.rl.addBattle(a),"true"===a.setup.initiative.started&&c.pf.addBattle(a),"false"===a.setup.initiative.started&&c.ps.addBattle(a)}),c}}]).service("statSelectorResult",[function(){return function(a,b){var c={};return _.each(a,function(a){var d=a.score;void 0===c[d]&&(c[d]=b()),c[d].addBattle(a)}),c}}]).service("statSelectorTag",[function(){return function(a,b){var c={};return _.each(a,function(a){_.each(a.tags,function(d){void 0===c[d]&&(c[d]=b()),c[d].addBattle(a)})}),c}}]),angular.module("jlogApp.services").service("stats",["statEntryMyCaster","statEntryOppName","statEntryOppCaster","statEntryEvent","statEntryScenario","statEntrySize","statEntryInit","statEntryResult","statEntryPointScenario","statEntryPointArmy","statEntryPointKill","statEntryTag","statSelectorMyCaster","statSelectorOppName","statSelectorOppCaster","statSelectorEvent","statSelectorScenario","statSelectorSize","statSelectorInit","statSelectorResult","statSelectorTag","battles_display",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){function w(a,b){var c=b();return _.each(a,function(a){c.addBattle(a)}),c}return{ENTRIES:{my_caster:{desc:"My Caster",factory:a},opp_name:{desc:"Opp. Name",factory:b},opp_caster:{desc:"Opp. Caster",factory:c},event:{desc:"Event",factory:d},scenario:{desc:"Scenario",factory:e},size:{desc:"Size",factory:f},initiative:{desc:"Initiative",factory:g},result:{desc:"Result",factory:h},point_scenario:{desc:"Scenario Points",factory:i},point_army:{desc:"Army Points",factory:j},point_Kill:{desc:"Kill Points",factory:k},tag:{desc:"Tag",factory:l}},SELECTORS:{my_caster:{desc:"My Caster",factory:m},opp_name:{desc:"Opp. Name",factory:n},opp_caster:{desc:"Opp. Caster",factory:o},event:{desc:"Event",factory:p},scenario:{desc:"Scenario",factory:q},size:{desc:"Size",factory:r},init:{desc:"Initiative",factory:s},result:{desc:"Result",factory:t},tag:{desc:"Tag",factory:u}},collections:{},legends:{},colors:{},generate:function(a,b){_.has(this.ENTRIES,a)&&_.has(this.SELECTORS,b)&&(this.collections[a]=this.collections[a]||{},this.collections[a].all=this.collections[a].all||w(v.sorted_list,this.ENTRIES[a].factory),this.collections[a][b]=this.collections[a][b]||this.SELECTORS[b].factory(v.sorted_list,this.ENTRIES[a].factory))}}}]),angular.module("jlogApp.services").factory("storage",["$window",function(a){var b={setItem:function(){return a.localStorage.setItem.apply(a.localStorage,arguments)},getItem:function(){return a.localStorage.getItem.apply(a.localStorage,arguments)},KEYS:{BATTLES:"jlog_battles",OPPONENTS:"jlog_opponents",EVENTS:"jlog_events",SCENARIOS:"jlog_scenarios",TAGS:"jlog_tags",FILTER:"jlog_filter"},clearJLogKeys:function(){_.each(b.KEYS,function(a){b.setItem(a,"")})}};return b}]),angular.module("jlogApp.services").service("tags",["storage",function(a){var b={list:[]},c=function(){a.setItem(a.KEYS.TAGS,JSON.stringify(b.list))},d=function(){return JSON.parse(a.getItem(a.KEYS.TAGS)).sort()},e=function(){var b=a.getItem(a.KEYS.TAGS);return"string"==typeof b&&b.length>0},f=function(a){if(b.list=[],_.isArray(a)){var c={};_.each(a,function(a){_.isArray(a.tags)&&_.each(a.tags,function(a){_.isString(a)&&(c[a]=!0)})}),b.list=_.keys(c),b.list.sort()}};return b.create=function(a){f(a),c()},b.init=function(a){e()?this.list=d():this.create(a)},b.update=c,b.add=function(a){0<a.length&&(this.list.push(a),this.list.sort(),c())},b.remove=function(a){var b=this.list.indexOf(a);b>=0&&(this.list.splice(b,1),c())},b}]);