<div class="container"
     id="backup">
  <ul class="nav nav-tabs"
      ng-init="panel='file'">
    <li ng-class="{ 'active': panel==='file' }">
      <a ng-click="panel='file'">File</a>
    </li>
    <li ng-class="{ 'active': panel==='online' }">
      <a ng-click="panel='online'">Online</a>
    </li>
    <li ng-class="{ 'active': panel==='ig' }">
      <a ng-click="panel='ig'">IronGrudge</a>
    </li>
    <li ng-class="{ 'active': panel==='debug' }">
      <a ng-click="panel='debug'">Debug</a>
    </li>
  </ul>
  <div ng-show="panel==='file'">
    <div class="panel panel-info">
      <div class="panel-heading">
        <h4 class="panel-title">Save to file</h4>
      </div>
      <div class="panel-body">
        <form>
          <div class="form-group">
            <label>Save backup file</label>
            <a class="form-control"
               ng-show="backup.url"
               ng-href="{{backup.url}}"
               download="{{backup.name}}">
              {{backup.name}}
            </a>
          </div>
          <div class="form-group">
            <label>Or copy JSON text :</label>
            <textarea class="form-control"
                      ng-model="backup.text">
            </textarea>
          </div>
        </form>
      </div>
    </div>
    <div class="panel panel-info">
      <div class="panel-heading">
        <h4 class="panel-title">Load from File</h4>
      </div>
      <div class="panel-body">
        <form>
          <div class="form-group">
            <label>Choose a JLog json backup file :</label>
            <input class="form-control"
                   id="import-file"
                   type="file"
                   ea-file="doReadFile('json', file)" />
          </div>
          <div class="form-group">
            <div class="text-warning"
                 ng-repeat="e in read_result.json">
              {{::e}}
            </div>
          </div>
          <div class="form-group">
            <label>Or paste JSON text :</label>
            <textarea class="form-control"
                      ng-model="read_text">
            </textarea>
          </div>
          <button class="btn btn-default"
                  type="button"
                  ng-click="doReadText('json', read_text)">
            <div class="icon-sprite icon-file"></div>
            Read JSON
          </button>
        </form>
      </div>
    </div>
  </div>
  <div ng-show="panel==='online'">
    <div class="panel panel-info">
      <div class="panel-heading">
        <h4 class="panel-title">Sync / Upload</h4>
      </div>
      <div class="panel-body">
        <button class="btn btn-default"
                type="button"
                ng-click="doUploadData()">
          Upload current data to server
          <span class="icon-sprite icon-upload"></span>
        </button>
        <p class="result">
          <strong class="text-{{upload.id === null ? 'warning' : 'success'}}">
            {{upload.msg | capitalise }}
          </strong>
        </p>
        <p ng-hide="upload.id">
          You can temporarily upload your current data to the web server.
          This will generate an Id that you can use in the Sync / Download section
          on another device to synchronize your data.
          The generated Id and the uploaded data are not permanent and
          will be cleared after a given period of time.
        </p>
        <p ng-show="upload.id">
          <strong>Sync Id :</strong> {{upload.id}}<br/>
          Use this Sync ID on your other device, in the download input below.
        </p>
      </div>
    </div>
    <div class="panel panel-info">
      <div class="panel-heading">
        <h4 class="panel-title">Sync / Download</h4>
      </div>
      <div class="panel-body">
        <p>
          Enter below the Sync ID given to you after uploading from another device.
        </p>
        <form name="upload" ng-submit="doDownloadData()">
          <div class="input-group">
            <input type="text"
                   class="form-control"
                   ng-model="download.id"
                   placeholder="Sync Id..." />
            <span class="input-group-btn">
              <button style="min-width:30px"
                      class="btn btn-default"
                      type="submit">
                <span class="icon-sprite icon-download"></span>
              </button>
            </span>
          </div>
        </form>
        <p class="result">
          <strong class="text-warning">
            {{download.msg | capitalise}}
          </strong>
        </p>
      </div>
    </div>
  </div>
  <div ng-show="panel==='ig'">
    <div class="panel panel-info">
      <div class="panel-heading">
        <h4 class="panel-title">Import IronGrudge</h4>
      </div>
      <div class="panel-body">
        <form ng-submit="doReadText('ig', import_text)">
          <div class="form-group">
            <label>Choose an IronGrudge CSV file :</label>
            <input class="form-control"
                   id="import-ig-file"
                   type="file"
                   ea-file="doReadFile('ig', file)" />
          </div>
          <div class="text-warning"
               ng-repeat="e in read_result.ig">
            {{::e}}
          </div>
          <div class="form-group">
            <label>Or paste CSV text :</label>
            <textarea class="form-control"
                      ng-model="import_text">
            </textarea>
            <button class="btn btn-default"
                    type="submit">
              <span class="icon-sprite icon-file"></span>
              Read CSV
            </button>
          </div>
        </form>
        <p>Iron Grudge CSV files are generated by exporting the SQLite backup file from IrongGrudge.</p>
        <p>
          You can use the SQLite Manager firefox plugin to perform this operation.
          The SQL query you need to use in order to generate the correct CSV file is :
        </p>
        <a ng-hide="_show_sql"
           ng-click="_show_sql=true">Click to show SQL query...</a>
        <code ng-show="_show_sql">
          SELECT battle.date, my_faction.name, my_caster.shortname, player.name, opp_faction.name, opp_caster.shortname, battle.result, battle.controlPoints, battle.armyPoints, battle.killPoints, battle.opponentControlPoints, battle.opponentArmyPoints, battle.opponentKillPoints, scenario.name, battle.points, event.name, battle.initiative, battle.comment
          FROM battle
          LEFT JOIN army my_army ON battle.armyId=my_army._id
          LEFT JOIN faction my_faction ON my_army.factionId=my_faction._id
          LEFT JOIN caster my_caster ON my_army.casterId=my_caster._id
          LEFT JOIN player ON battle.opponentId=player._id
          LEFT JOIN army opp_army ON battle.opponentArmyId=opp_army._id
          LEFT JOIN faction opp_faction ON opp_army.factionId=opp_faction._id
          LEFT JOIN caster opp_caster ON opp_army.casterId=opp_caster._id
          LEFT JOIN scenario ON battle.scenarioId=scenario._id
          LEFT JOIN event ON battle.eventId=event._id;
        </code>
      </div>
    </div>
  </div>
  <div ng-show="panel==='debug'">
    <div class="panel panel-info">
      <div class="panel-heading">
        <h4 class="panel-title">Debug</h4>
      </div>
      <div class="panel-body">
        <button class="btn btn-default"
                ng-click="doClearStorage()">
          Clear Local Storage
        </button>
        <p>
          This will clear all data stored in memory.
          You can then reload the data from a backup file to restart in a clean state.
        </p>
        <!-- <button class="btn btn-default" -->
        <!--         ng-click="doReadOldDatabase()"> -->
        <!--   Read Old Database -->
        <!-- </button> -->
        <!-- <p> -->
        <!--   {{old_data}} -->
        <!-- </p> -->
      </div>
    </div>
  </div>
</div>
